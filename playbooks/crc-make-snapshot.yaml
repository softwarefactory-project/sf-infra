---
# Basic usage:
# ansible-playbook playbooks/crc-make-snapshot.yaml
#
# More controled usage:
# ansible-playbook -e "ansible_host_key_checking=False" -e "system_distro=centos" -e "system_release=9" playbooks/crc-make-snapshot.yaml
# More info: roles/next-gen/crc-image/README.md

- name: Spawning a crc VM
  hosts: localhost
  tasks:
    - name: Set important facts
      ansible.builtin.set_fact:
        cloud_name: nodepool-tripleo
        flavor: ci.m1.xlarge
        ssh_keypair_name: image-builder
        vm_name: infra-dfg-team-crc
        net_id: 7abff1a9-a103-46d0-979a-1f1e599f4f41
        snapshot_name: "infra-dfg-team-crc-snapshot"
        # Add ssh key
        ssh_pub_key: ""
        # Or set the path for ssh pub key
        ssh_pub_path: ~/.ssh/id_ed25519.pub
        # can be: centos or rhel
        system_distro: "{{ system_distro | default('centos') }}"
        # for centos: 9, for rhel: 9-2
        system_release: "{{ system_release | default(9) }}"

    - name: Check if there is already VM with such name
      ansible.builtin.include_role:
        name: next-gen/crc-image
        tasks_from: check_vm.yaml

    - name: Find newest image
      ansible.builtin.include_role:
        name: next-gen/crc-image
        tasks_from: find_image.yaml

    - name: Create a VM
      ansible.builtin.include_role:
        name: next-gen/crc-image
        tasks_from: create_vm.yaml

    - name: Get VM info
      ansible.builtin.include_role:
        name: next-gen/crc-image
        tasks_from: get_vm_info.yaml

# This playbook deploy crc and prepare VM to make a snapshot, that later
# can be deployed in CI.
- name: Deploy CRC
  hosts: crc.dev
  pre_tasks:
    - name: Read file with openshift_pull_secret
      ansible.builtin.include_vars:
        file: ~/.ansible_crc_vars.yaml
      delegate_to: localhost

    - name: Ensure cloud init is installed and is running
      ansible.builtin.include_role:
        name: next-gen/crc-image
        tasks_from: prepare_vm.yaml

    - name: Enable nested virt, install other kernel and configure other packages
      ansible.builtin.include_role:
        name: next-gen/crc-image
        tasks_from: configure_vm.yaml
  roles:
    - extra/crc
  post_tasks:
    - name: Ensure cloud init is installed and snapshot would be able to boot
      ansible.builtin.include_role:
        name: next-gen/crc-image
        tasks_from: post_vm.yaml

- name: Making snapshot of CRC instance
  hosts: localhost
  tasks:
    - name: Change CRC base image
      block:
        - name: Make snapshot
          ansible.builtin.include_role:
            name: next-gen/crc-image
            tasks_from: make_snapshot.yaml

        - name: Remove old image
          ansible.builtin.include_role:
            name: next-gen/crc-image
            tasks_from: remove_image.yaml

        - name: Rename snapshot image
          ansible.builtin.include_role:
            name: next-gen/crc-image
            tasks_from: rename_image.yaml
      always:
        - name: Deleting instance
          openstack.cloud.server:
            name: "{{ vm_name }}"
            cloud: "{{ cloud_name }}"
            state: absent
