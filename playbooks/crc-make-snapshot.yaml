---
# Workflow:
# - localhost got file "~/.ansible_crc_vars.yaml" that contains openshift_pull_secret var,
# - localhost spawns crc.dev instance
# - crc.dev is deploying crc
# - after crc is done, comming back to localhost that is executing snapshot withname {{ snapshot_name }}
# - when the snapshot is done, remove the {{ finally_image_name }} - usually it is "centos-{{ centos_release }}-stream-crc"
# - change the "{{ snapshot_name }} to "centos-{{ centos_release }}-stream-crc"
# - remove the crc VM
#
# Run playbook with following command:
#
# ansible-playbook -e "centos_release=9" playbooks/crc-make-snapshot.yaml
#
# Additional variables:
### openstack - preparations ###
# - define image_name
# - define image_ssh_user
### crc ###
# - crc_parameters: "--memory 14336 --disk-size 60 --cpus 6"
# - testing_kernel
# - nested_virtualization
# - disable_selinux
#
# NOTE: Playbook requires: ansible-galaxy collection install openstack.cloud
# If it's not updated, it can raise an error:
# openstack.cloud.server error 'volumes is not found. openstack.compute.v2.server.Server objects do not support setting arbitrary keys through the dict interface.
#
# NOTE: The snapshot is using image: cloud-centos-9-stream-tripleo that is using
# "zuul" as regular user. More info: https://softwarefactory-project.io/r/c/software-factory/sf-infra/+/28356/comments/b4d1830e_5060e846
#
- name: Spawning a crc VM
  hosts: localhost
  tasks:
    - name: Set important facts
      ansible.builtin.set_fact:
        cloud_name: nodepool-tripleo
        flavor: ci.m1.xlarge
        ssh_keypair_name: bridgesf
        vm_name: infra-dfg-team-crc
        net_id: 7abff1a9-a103-46d0-979a-1f1e599f4f41
        finally_image_name: "centos-{{ centos_release | default('9') }}-stream-crc"
        snapshot_name: "infra-dfg-team-crc-snapshot"

    - name: Take newest image for {{ centos_release | default('9') }}
      shell: |
        export OS_CLOUD={{ cloud_name }}
        openstack image list -c Name -f value | grep cloud-centos-{{ centos_release | default('9') }}-stream-tripleo | head -n1
      register: base_centos_image
      when: image_name is not defined and not image_name

    - name: Change finally_image_name var, if testing_kernel
      when: testing_kernel | default(false)
      set_fact:
        finally_image_name: "centos-{{ centos_release }}-stream-crc-alt-kernel"

    - name: Create VM
      openstack.cloud.server:
        state: present
        cloud: "{{ cloud_name }}"
        name: "{{ vm_name }}"
        image: "{{ image_name | default(base_centos_image.stdout) }}"
        key_name: "{{ ssh_keypair_name }}"
        timeout: 300
        flavor: "{{ flavor }}"
        nics:
          - net-id: "{{ net_id }}"
        meta:
          hostname: crc.dev
        security_groups:
          - default

    - name: Get server info
      openstack.cloud.server_info:
        cloud: "{{ cloud_name }}"
        server: "{{ vm_name }}"
      register: server_info

    - name: Fail when ip address not available
      ansible.builtin.fail:
        msg: "Can not find ip address for server {{ vm_name }}. Too many vms available or cloud provider issue?"
      when: not server_info.servers[0].access_ipv4

    - name: Add host into the inventory
      ansible.builtin.add_host:
        hostname: crc.dev
        ansible_ssh_host: "{{ server_info.servers[0].access_ipv4 }}"
        ansible_ssh_port: 22
        ansible_ssh_user: "{{ image_ssh_user | default('zuul') }}"

    - name: Wait for SSH to be up
      ansible.builtin.wait_for:
        host: "{{ server_info.servers[0].access_ipv4 }}"
        port: 22
        delay: 10

# This playbook deploy crc and prepare VM to make a snapshot, that later
# can be deployed in CI.
- name: Deploy CRC
  hosts: crc.dev
  vars:
    # for extra/crc role
    crc_debug: true
    prepare_sfoperator: false
    # optional
    # crc_parameters: "--memory 14336 --disk-size 60 --cpus 6"
  pre_tasks:
    - name: Read file with openshift_pull_secret
      ansible.builtin.include_vars:
        file: ~/.ansible_crc_vars.yaml
      delegate_to: localhost

    - name: Update packages
      become: true
      ansible.builtin.yum:
        name: '*'
        state: latest

    - name: Ensure CentOS runs with selinux permissive
      become: true
      when: disable_selinux | default(false)
      ansible.posix.selinux:
        policy: targeted
        state: permissive

    - name: Enable nested virtualization
      when: nested_virtualization | default(true)
      block:
        - name: Install packages
          become: true
          ansible.builtin.yum:
            name:
              - qemu-kvm-common
            state: present

        - name: Check if CPU vendor is Intel
          ansible.builtin.shell: |
            grep -qi intel /proc/cpuinfo
          ignore_errors: true
          register: _intel_vendor

        - name: Enable nested virtualization - Intel
          become: true
          ansible.builtin.lineinfile:
            path: /etc/modprobe.d/kvm.conf
            regexp: '^#options kvm_intel nested=1'
            line: 'options kvm_intel nested=1'
          when: _intel_vendor.rc == 0
          register: _nested_intel

        - name: Enable nested virtualization - AMD
          become: true
          ansible.builtin.lineinfile:
            path: /etc/modprobe.d/kvm.conf
            regexp: '^#options kvm_amd nested=1'
            line: 'options kvm_amd nested=1'
          when: _intel_vendor.rc == 1
          register: _nested_amd

        - name: Reboot host to apply nested virtualization change
          become: true
          ansible.builtin.reboot:
          when: _nested_intel.changed or _nested_amd.changed

    - name: Enable testing kernel
      when: ansible_distribution_major_version == '9' and testing_kernel | default(false)
      block:
        - name: install kernel
          become: true
          ansible.builtin.shell: |
            rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org
            dnf install -y https://www.elrepo.org/elrepo-release-9.el9.elrepo.noarch.rpm
            dnf --enablerepo=elrepo-kernel install -y kernel-ml

        - name: Reboot host
          become: true
          ansible.builtin.reboot:

    - name: Install packages - partially for TripleO
      become: true
      ansible.builtin.yum:
        name:
          - make
          - git
          - vim
          - golang
          - tar
          - ansible-core
          - skopeo
          - sqlite
          - jq
          - podman
        state: present

  roles:
    - extra/crc

  post_tasks:
    - name: Remove pull-secret file
      ansible.builtin.file:
        path: pull-secret.txt
        state: absent

    - name: Ensure cloud-init is installed
      become: true
      ansible.builtin.yum:
        name:
          - cloud-init
          - golang
        state: present

    - name: Cleanup dnf cache
      become: true
      ansible.builtin.command: dnf clean all

    # dpawlik: for some reason, ssh local keys in /etc/ssh/ are not generated during start.
    - name: Create crontab entry to generate local ssh keys
      become: true
      ansible.builtin.copy:
        content: |
          @reboot root /usr/bin/ssh-keygen -A; systemctl start sshd
        dest: /etc/cron.d/ssh_gen
        mode: "0644"

    - name: Set proper selinux label
      become: true
      ansible.builtin.shell: |
        /usr/bin/chcon system_u:object_r:system_cron_spool_t:s0 /etc/cron.d/ssh_gen

- name: Making snapshot of CRC instance
  hosts: localhost
  tasks:
    - name: Change CRC base image
      block:
        - name: Create snapshot
          shell: |
            export OS_CLOUD={{ cloud_name }}
            openstack server image create {{ vm_name}} --name {{ snapshot_name }}

        - name: Wait until the snapshot is done
          shell: |
            export OS_CLOUD={{ cloud_name }}
            for r in {1..60}; do
                img_status=$(openstack image show {{ snapshot_name }} -c status -f value)
                if [ $img_status != 'active' ]; then
                    echo "Image is still not active, sleeping..."
                    sleep 10
                else
                    echo "Image is active!"
                fi
            done

        - name: Remove old crc image
          openstack.cloud.image:
            cloud: "{{ cloud_name }}"
            name: "{{ finally_image_name }}"
            state: absent

        - name: Change snapshot name
          shell: |
            export OS_CLOUD={{ cloud_name }}
            openstack image set {{ snapshot_name }} --name {{ finally_image_name }}

      always:
        # FIXME: should we always delete CRC vm even when it will be some failure?
        - name: Deleting instance
          openstack.cloud.server:
            name: "{{ vm_name }}"
            cloud: "{{ cloud_name }}"
            state: absent
