---
- name: Renew Letsencrypt SSL certificates
  hosts: registry.rdoproject.org
  vars:
    registry_host: "{{ inventory_hostname }}"

  roles:
    - {role: registry-renew-certificates, become: true}

  post_tasks:
    # NOTE(dpawlik) Copy new certs to the bridge host, because
    # it will be copied back using Openshift Ansible, when some patch set
    # will trigger sf-infra-configure-registry job.
    - name: Make sure that directory exists on bridge host
      file:
        path: /home/fedora/letsencrypt
        state: directory
    - name: Copy generated certs to the bridge host
      synchronize:
        src: /etc/letsencrypt/
        dest: /home/fedora/letsencrypt
        mode: pull
        recursive: yes
        archive: yes
      become: true

- name: Redeploy all certificates
  hosts: registry.rdoproject.org
  vars:
    registry_host: "{{ inventory_hostname }}"
  tasks:
    - name: include vars
      include_vars:
        file: host_vars/registry.rdoproject.org.yml

- name: Run Openshift Ansible redeploy-certificates
  import_playbook: "{{ '~/src/github.com/rdo-infra/openshift-ansible/playbooks/redeploy-certificates.yml' | expanduser }}"
