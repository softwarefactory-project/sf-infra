---
- import_playbook: site_bridge.yaml

- hosts: rdo
  roles:
    - sf-infra-base

- hosts: rdo
  roles:
    - node-exporter
    - update-host

- hosts: backup-rdo
  roles:
    - backup-client

- hosts: backup-server
  vars_files:
    - vars/dlrn-db.yaml
  roles:
    - mysqld-exporter
    - backup-srv
    - backup-monitoring

- hosts: baremetal02.rdoproject.org
  roles:
    - sf-ssh
    - volume

- hosts: mirror.regionone.vexxhost.rdoproject.org
  roles:
    - setup-ssl
    - afs-mirror
    - afs-monitoring

- hosts: mirror.regionone.ibm-bm2-nodepool.rdoproject.org
  roles:
    - setup-ssl-self-signed
    - afs-mirror

- hosts: rdo
  roles:
    - sf-ssh

- hosts: managesf.review.rdoproject.org
  roles:
    - hostname
    - sf-install-server
    - acme-tiny
    - apache-exporter

- hosts: logserver.rdoproject.org
  roles:
    - hostname
    - volume
    - logserver
    - setup-ssl

- hosts: images.rdoproject.org
  roles:
    - hostname
    - volume
    - setup-ssl
    - firewalld
    - {role: image-server, become: true}

- hosts: elk.review.rdoproject.org
  roles:
    - volume
    - {name: 'logscraper', become: true}
    - {name: 'logsender', become: true}
    - opensearch-monitoring

- hosts: quay.rdoproject.org
  pre_tasks:
    - name: Setup Quay partition
      # NOTE: take care: some variables are devices and some device.
      vars:
        lvm: "{{ partitions['quay']['lvm'] | default('') }}"
        devices: "{{ partitions['quay']['devices'] | list | default('') }}"
        mountpoint: "{{ partitions['quay']['mountpoint'] | default('') }}"
        vg_name: "{{ partitions['quay']['vg_name'] | default('') }}"
        lv_name: "{{ partitions['quay']['lv_name'] | default('') }}"
      include_role:
        name: volume
    - name: Setup Postgres partition
      vars:
        lvm: "{{ partitions['db']['lvm'] | default('') }}"
        device: "{{ partitions['db']['device'] | default('') }}"
        mountpoint: "{{ partitions['db']['mountpoint'] | default('') }}"
      include_role:
        name: volume
  roles:
    - hostname
    - setup-ssl
    - quay
    - quay-project-creation
  vars:
    self_signed_certs: false
    initial_config: false
    # Use standalone server to get SSL certs from certbot
    additional_params: '--standalone'
    http_service_name: 'standalone'

- hosts: opensearch.rdoproject.org
  pre_tasks:
    - name: Setup Opensearch partition
      vars:
        lvm: "{{ partitions['opensearch']['lvm'] | default('') }}"
        devices: "{{ partitions['opensearch']['devices'] | list | default('') }}"
        mountpoint: "{{ partitions['opensearch']['mountpoint'] | default('') }}"
        vg_name: "{{ partitions['opensearch']['vg_name'] | default('') }}"
        lv_name: "{{ partitions['opensearch']['lv_name'] | default('') }}"
      include_role:
        name: volume
  roles:
    - hostname
    - setup-ssl
    - {name: ansible-role-elastic-recheck, become: true}
    - opensearch-monitoring
