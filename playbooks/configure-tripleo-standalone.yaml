- hosts: bridge.softwarefactory-project.io
  gather_facts: no
  tasks:
    - name: Get "{{ cloud_image }}"
      get_url:
        url: "{{ cloud_image_url }}"
        dest: "/home/fedora/{{ cloud_image }}.qcow2"

    - name: Add "{{ cloud_image }}" on osp deployment
      os_image:
        cloud: "{{ cloud }}"
        name: "{{ cloud_image }}"
        state: present
        filename: "/home/fedora/{{ cloud_image }}.qcow2"

    - name: Add keypairs on osp deployment
      os_keypair:
        cloud: "{{ cloud }}"
        name: bridge
        public_key: "{{ keypair }}"
      loop:

    - name: Create servers
      os_server:
        cloud: "{{ cloud }}"
        name: "{{ item.name }}"
        flavor: "{{ item.flavor }}"
        image: "{{ cloud_image }}"
        key_name: bridge
        network: hostonly
        security_groups:
          - allow_ssh
        boot_from_volume: "{% if item.volume_size is defined %} yes {% else %} no {% endif %}"
        terminate_volume: yes
        volume_size: "{% if item.volume_size is defined %} {{ item.volume_size }} {% else %} 0 {% endif %}"
      loop: "{{ servers }}"

    - name: Get deployed instances on cloud
      os_server_info:
        cloud: "{{ cloud }}"
        server: ibm-*
      register: result

    - debug:
        msg: "{{ item.name }} => {{ item.public_v4 }}"
      loop: "{{ result.openstack_servers }}"
      loop_control:
        label:
          - "{{ item.name }}"
          - "{{ item.public_v4 }}"
