---
# This is the main playbook that trampoline on the bridge to run the site.yaml
- hosts: localhost
  vars:
    bridge_name: bridge.softwarefactory-project.io
    bridge_ip: 38.102.83.244
    # NOTE(jpena): if the bridge host is ever recreated, we will have to update this key
    bridge_key: "{{ bridge_name }},{{ bridge_ip }},bridge ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBAADRnrMKg7ZvvG4zrMCjEnT1/RkfXAagSBYoQfTbzrHj+BoFGDbt4F1rM+PA+cJUJ2KS5ZCktJLWNeyYKCuKOg="
  tasks:
    - add_host:
        name: "{{ bridge_name }}"
        ansible_python_interpreter: python3
        ansible_host: "{{ bridge_ip }}"
        ansible_user: fedora
        ansible_connection: ssh
        groups: bridge

    - known_hosts:
        name: "{{ bridge_name }}"
        key: "{{ bridge_key }}"

- hosts: bridge.softwarefactory-project.io
  tasks:
    - name: Synchronize src repos to workspace directory.
      synchronize:
        dest: "~/src/"
        src: "{{ zuul.executor.src_root }}/"
      no_log: true

    - name: Check if openstack client exists
      command: which openstack
      register: _openstack_client
      failed_when: _openstack_client.rc not in [0,1]
      changed_when: false

    - name: Install packages
      become: yes
      package:
        name:
          - ansible
          - git
          - make
          - python3-netaddr
          - tmux
          # os_client
          - gcc
          - python3-devel
        state: latest

    - include_tasks: tasks/standalone-setup.yaml
      loop: "{{ standalone_deployments }}"
      no_log: true

- hosts: baremetal
  gather_facts: yes
  tasks:
    - name: Add rule for monitoring
      iptables:
        chain: INPUT
        protocol: tcp
        destination_port: 9100
        source: 38.102.83.250
        ctstate: NEW
        syn: match
        jump: ACCEPT
        comment: node_exporter
        action: insert
        rule_num: 61

    - name: Save iptables rules
      command: /usr/libexec/iptables/iptables.init save

    - name: Create flavors
      os_nova_flavor:
        cloud: standalone
        name: "{{ item.name }}"
        disk: "{{ item.disk | default(0) }}"
        ram: "{{ item.ram | default(256) }}"
        vcpus: "{{ item.vcpus | default(1) }}"
        state: "{{ item.state | default('present') }}"
      become: yes
      become_user: stack
      environment:
        OS_CLOUD: standalone
      loop: "{{ flavors }}"

# todo: specific to bm2
# should be adapted after deploying bm3 fingergw
- hosts: baremetal02.rdoproject.org
  gather_facts: yes
  tasks:

    - name: Forward finger port (7979) to ibm-zfgw
      iptables:
        chain: FORWARD
        protocol: tcp
        destination_port: 7979
        destination: 192.168.25.80
        jump: ACCEPT
        comment: Forward rule for fingergw

    - name: DNAT finger port (7979) to ibm-zfgw
      iptables:
        table: nat
        chain: PREROUTING
        in_interface: bond1
        protocol: tcp
        destination_port: 7979
        jump: DNAT
        to_destination: 192.168.25.80:7979
        comment: PREROUTING rule for fingergw

    - name: Save iptables rules
      command: /usr/libexec/iptables/iptables.init save
