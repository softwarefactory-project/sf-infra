---
# This is the main playbook that trampoline on the bridge to run the site.yaml
- hosts: localhost
  vars:
    bridge_name: bridge.softwarefactory-project.io
    bridge_ip: 38.102.83.244
    bridge_key: "{{ bridge_name }},{{ bridge_ip }},bridge ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIG+w4PGQtn2VpFwEpww7uYaVcubHMvKCiM1uj6NOwx9X"
  tasks:
    - add_host:
        name: "{{ bridge_name }}"
        ansible_python_interpreter: python3
        ansible_host: "{{ bridge_ip }}"
        ansible_user: fedora
        ansible_connection: ssh
        groups: bridge

    - known_hosts:
        name: "{{ bridge_name }}"
        key: "{{ bridge_key }}"

- hosts: bridge.softwarefactory-project.io
  tasks:
    - name: Synchronize src repos to workspace directory.
      synchronize:
        dest: "~/src/"
        src: "{{ zuul.executor.src_root }}/"
      no_log: true

    - name: Run configuration playbook
      args:
        chdir: "~/{{ zuul.projects['softwarefactory-project.io/software-factory/sf-infra'].src_dir }}"
      command: ansible-playbook -vv playbooks/rdo-registry.yaml
      environment:
        ANSIBLE_CONFIG: ansible/ansible-registry.cfg
        # Provided by Zuul secret
        ARA_API_PASSWORD: "{{ ara_api.password }}"

    - name: Create ansible registry renew log directory
      become: true
      file:
        path: "{{ item }}"
        state: directory
        owner: fedora
        group: fedora
      loop:
        - /var/log/registry-cert-renew
        - /var/lib/sf-infra

    - name: Copy renew certificate script
      copy:
        content: |
          cd  /home/fedora/src/softwarefactory-project.io/software-factory/sf-infra;
          export ANSIBLE_CONFIG=ansible/ansible-registry.cfg;
          export ANSIBLE_LOG_PATH=/var/log/registry-cert-renew/ansible-$(date '+%Y-%m-%d').log;
          /usr/bin/ansible-playbook playbooks/registry-renew-certificates.yml -i ansible/hosts.yaml
        dest: /var/lib/sf-infra/registry-renew.sh

    # Renew cert each week - Sunday at 0:00
    - name: Create cron job for renewing certificate
      cron:
        name: Renew registry certificate
        special_time: weekly
        job: bash /var/lib/sf-infra/registry-renew.sh
