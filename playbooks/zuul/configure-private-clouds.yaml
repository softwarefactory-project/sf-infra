- hosts: baremetal
  gather_facts: yes
  tasks:
    - name: Download tripleo-ci users ssh keys
      get_url:
        url: https://raw.githubusercontent.com/rdo-infra/ci-config/master/ci-scripts/infra-setup/inventory/group_vars/all.yml
        dest: /tmp/common.yml

    - name: Create tripleo user
      user:
        name: tripleo

    - name: Ensure ci_directory_path
      set_fact:
        ci_directory_path: "/var/lib/ansible"

    - name: Load tripleo keys
      include_vars:
        file: /tmp/common.yml
        name: tripleo

    - name: Add users in ssh/authorized_key
      authorized_key:
        user: tripleo
        key: "{{ item.authorized_keys }}"
      loop: "{{ tripleo.users }}"
      when: item.authorized_keys is defined

    - name: Add rule for monitoring
      iptables:
        chain: INPUT
        protocol: tcp
        destination_port: 9100
        source: 38.102.83.250
        ctstate: NEW
        syn: match
        jump: ACCEPT
        comment: node_exporter
        action: insert
        rule_num: 61

    - name: Save iptables rules
      command: /usr/libexec/iptables/iptables.init save

    - name: Create flavors
      shell: |
        if ! openstack flavor show {{ flavor.name }}; then
           openstack flavor create --ram {{ flavor.ram }} --disk {{ flavor.disk }} --vcpu {{ flavor.vcpus }} --public {{ flavor.name }}
        fi
      environment:
        OS_CLOUD: standalone
      loop: "{{ flavors }}"
      loop_control:
        loop_var: flavor
      register: _output

- hosts: baremetal03.rdoproject.org
  gather_facts: yes
  tasks:
    - name: Forward finger port (7979) to ibm-zfgw
      iptables:
        chain: FORWARD
        protocol: tcp
        destination_port: 7979
        destination: 192.168.25.13
        jump: ACCEPT
        comment: Forward rule for fingergw

    - name: DNAT finger port (7979) to ibm-zfgw
      iptables:
        table: nat
        chain: PREROUTING
        in_interface: bond1
        protocol: tcp
        destination_port: 7979
        jump: DNAT
        to_destination: 192.168.25.13:7979
        comment: PREROUTING rule for fingergw

    - name: Save iptables rules
      command: /usr/libexec/iptables/iptables.init save

- hosts: baremetal04.rdoproject.org
  gather_facts: yes
  tasks:
    - name: Forward finger port (7900) to ibm-zfgw
      iptables:
        chain: FORWARD
        protocol: tcp
        destination_port: 7900
        destination: 192.168.26.13
        jump: ACCEPT
        comment: Forward rule for fingergw

    - name: DNAT finger port (7900) to ibm-zfgw
      iptables:
        table: nat
        chain: PREROUTING
        in_interface: bond1
        protocol: tcp
        destination_port: 7900
        jump: DNAT
        to_destination: 192.168.26.13:7900
        comment: PREROUTING rule for fingergw

    - name: Save iptables rules
      command: /usr/libexec/iptables/iptables.init save

    - name: Synchronize squid_htpasswd on bm4
      ansible.builtin.synchronize:
        src: "~/.squid_htpasswd"
        dest: "/home/stack/.squid_htpasswd"
      delegate_to: localhost

    - name: Set owner, group and mode for .squid_htpasswd
      ansible.builtin.file:
        path: "/home/stack/.squid_htpasswd"
        owner: stack
        group: stack
        mode: 0600

    - name: Configure squid service
      ansible.builtin.include_role:
        name: rdo/ibm-shiftstack-squid
