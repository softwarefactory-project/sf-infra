---
- name: "Create flavors on {{ item.cloud }}"
  os_nova_flavor:
    cloud: "{{ item.cloud }}"
    name: "{{ flavor.name }}"
    disk: "{{ flavor.disk | default(0) }}"
    ram: "{{ flavor.ram | default(256) }}"
    vcpus: "{{ flavor.vcpus | default(1) }}"
    state: "{{ flavor.state | default('present') }}"
  loop: "{{ flavors }}"
  loop_control:
    loop_var: flavor

- name: "Add keypairs on {{ item.cloud }}"
  os_keypair:
    cloud: "{{ item.cloud }}"
    name: bridge
    public_key: "{{ keypair }}"

- name: "Set dns for {{ item.cloud }}"
  os_subnet:
    cloud: "{{ item.cloud }}"
    state: present
    network_name: hostonly
    name: hostonly-subnet
    cidr: 192.168.25.0/24
    dns_nameservers:
       - 1.1.1.1

- name: "Create security group rules for default"
  os_security_group_rule:
    cloud: "{{ item.cloud }}"
    state: present
    security_group: default
    protocol: tcp
    port_range_min: "{{ port }}"
    port_range_max: "{{ port }}"
    remote_ip_prefix: 0.0.0.0/0
  loop:
    - 22
    - 19885
  loop_control:
    loop_var: port

- name: "Create security group rule for allow_ssh"
  os_security_group_rule:
    cloud: "{{ item.cloud }}"
    state: present
    security_group: allow_ssh
    protocol: tcp
    port_range_min: 1
    port_range_max: 65535
    remote_ip_prefix: 0.0.0.0/0
  ignore_errors: yes
  # note: added for https://github.com/ansible/ansible/issues/76039

- name: Add ports and instances
  block:
    - name: "Create port {{ server.name }}"
      os_port:
        cloud: "{{ item.cloud }}"
        name: "{{ server.name }}"
        network: hostonly
        security_groups:
          - allow_ssh
        fixed_ips:
          - ip_address: "{{ server.ip }}"
      loop: "{{ item.servers }}"
      loop_control:
        loop_var: server

    - name: "Create server {{ server.name }}"
      os_server:
        cloud: "{{ item.cloud }}"
        name: "{{ server.name }}"
        flavor: "{{ server.flavor }}"
        image: "{{ cloud_image }}"
        key_name: bridge
        # don't wait for instance creation for there is issue when waiting for fip
        # "msg": "Timeout waiting for the floating IP to be attached."
        # but the fip is already attached
        wait: false
        security_groups:
          - allow_ssh
        nics:
          - port-name: "{{ server.name }}"
      loop: "{{ item.servers }}"
      loop_control:
        loop_var: server
