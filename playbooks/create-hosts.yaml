---
- hosts: bridge.softwarefactory-project.io
  gather_facts: yes
  vars:
    clouds:
      - {name: 'vexxhost-rdo', tenant: 'infra-rdo'}
      - {name: 'vexxhost-rdo', tenant: 'infra-sf'}
      - {name: 'vexxhost-rdo', tenant: 'nodepool-sf'}
    # NOTE: it is important to keep order, from which network ip address
    # has bigger priority than other.
    available_networks:
      - 'private-network'
      - 'oci-private-network'
      - 'provider_net_shared'
      - 'provider_net_shared_2'
      - 'provider_net_shared_3'
    temp_hosts_file: /tmp/hosts.yaml

  tasks:
    - ansible.builtin.set_fact:
        servers_ip: []

    - name: Create empty file content
      ansible.builtin.copy:
        content: |
          # This file is generated by the create-hosts playbook
          # And it is used to update the /etc/hosts by the generate-etc-hosts role
          inventory_hosts_ip:
        dest: "{{ temp_hosts_file }}"

    - ansible.builtin.include_tasks: tasks/create-hosts.yaml
      loop: "{{ clouds }}"
      loop_control:
        loop_var: cloud

    - name: Read new generated inventory_hosts_ip file
      ansible.builtin.include_vars: "{{ temp_hosts_file }}"

    - name: Fail, when the inventory_hosts_ip is empty
      ansible.builtin.fail:
        msg: "Can not continue! Temp file {{ temp_hosts_file }} is empty!"
      when: not inventory_hosts_ip

    - name: Copy new generated hosts file to /etc/hosts.yaml
      become: true
      ansible.builtin.copy:
        src: "{{ temp_hosts_file }}"
        dest: /etc/hosts.yaml
        remote_src: true

    - name: Show servers ip
      ansible.builtin.debug:
        msg: "{{ inventory_hosts_ip | to_yaml }}"
