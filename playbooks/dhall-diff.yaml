- hosts: all
  tasks:
    - name: Run make
      command: make
      args:
        chdir: "{{ zuul.project.src_dir }}"

    - name: Check for diff
      command: git diff
      args:
        chdir: "{{ zuul.project.src_dir }}"
      register: _git_diff

    - name: Abord on diff
      when: _git_diff.stdout
      failed_when: true
      debug:
        msg: |
          The repository content is not consistent.
          Please run `make` before `git commit`

          {% if _git_diff.stdout | regex_search('^-') %}
          You commited change in a YAML file without using the equivalent Dhall file.
          Please update the Dhall file first and run make.

          {% else %}
          You commited change in a Dhall file without running make.
          Please run `make` before `git commit`.

          {% endif %}

          The difference is:

          {{ _git_diff.stdout }}
