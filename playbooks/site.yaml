---
- hosts: bridge
  gather_facts: yes
  pre_tasks:
    - name: Ensure hostname is correct
      hostname:
        name: bridge.softwarefactory-project.io
      become: yes
  roles:
    - bridge-accounts
    - postfix
    - node-exporter

- hosts: backup
  roles:
    - node-exporter-rpm
    - backup-monitoring

- hosts: afs-mirror
  roles:
    - afs-mirror
    - node-exporter-rpm
    - afs-monitoring

- hosts: logreduce-mqtt
  roles:
    - node-exporter
    - custom-exporter
    - logreduce-mqtt-worker

- hosts: sf
  vars:
    sf_ssh_pub_key: "{{ install_server_sf_pub }}"
  roles:
    - node-exporter-rpm
    - sf-ssh

- hosts: install-server-sf
  vars:
    sf_ssh_priv_key: "{{ install_server_sf_key }}"
  roles:
    - sf-install-server

- hosts: prometheus
  pre_tasks:
    - name: Install requirements
      package:
        name:
          - podman
          - dnsmasq
      become: yes
  vars:
    certbot_plugin: "--apache"
    fqdn: "prometheus.monitoring.softwarefactory-project.io"
    ssl_cert_options:
      cert1:
        email: "softwarefactory-operations-team@redhat.com"
        domain: "prometheus.monitoring.softwarefactory-project.io"
        webroot: "/var/www/html"
  roles:
    - hostname
    - setup-ssl
    - monitoring-gateway
    - alert-manager
    - dnsmasq
    - grafana
    - node-exporter
    - blackbox-exporter
    - prometheus

- hosts: dlrn
  roles:
    - node-exporter-rpm
  tasks:
    - block:
        - name: Ensure firewalld is installed
          package:
            name: firewalld
        - name: Ensure firewalld service is running
          service:
            name: firewalld
            state: started
            enabled: yes
        - name: Enable port 9100 on firewall, it can be disabled by puppet-dlrn
          firewalld:
            port: 9100/tcp
            permanent: yes
            immediate: yes
            state: enabled
      become: yes

- hosts: trunk.rdoproject.org
  roles:
    - node-exporter-rpm
    - rdotrunk-checks

- hosts: trunk-centos7.rdoproject.org
  vars_files:
    - vars/dlrn.yaml
  roles:
    - swap
    - dlrn-server

- hosts: trunk-centos8.rdoproject.org
  vars_files:
    - vars/dlrn.yaml
  roles:
    - dlrn-server

- hosts: centos8-rpm-packaging-ci.rdoproject.org
  roles:
    - swap
    - dlrn-server

- hosts: logserver.rdoproject.org
  vars:
    devices:
      - /dev/vdb
      - /dev/vdc
    mountpoint: '/var/www/logs'
    mount_owner: 'loguser'
    mount_group: 'apache'
    lvm: True
    vg_name: 'vglog'
    lv_name: 'log'
    certbot_install: false
    certbot_plugin: "--apache"
    fqdn: "logserver.rdoproject.org"
    ssl_cert_options:
      cert1:
        email: "softwarefactory-operations-team@redhat.com"
        domain: "logserver.rdoproject.org"
        webroot: "/var/www/logs"
  roles:
    - hostname
    - volume
    - logserver
    - setup-ssl
    - node-exporter-rpm

- hosts: images-vexxhost.rdoproject.org
  vars:
    lvm: True
    vg_name: 'vgimage'
    lv_name: 'image'
    devices:
      - /dev/vdb
    mountpoint: '/var/www/html/images'
    ssl_cert_options:
      cert1:
        email: "softwarefactory-operations-team@redhat.com"
        domain: "images-vexxhost.rdoproject.org"
        webroot: "/var/www/html"
      cert2:
        email: "softwarefactory-operations-team@redhat.com"
        domain: "images.rdoproject.org"
        webroot: "/var/www/html"
  roles:
    - hostname
    - volume
    - node-exporter-rpm
    - setup-ssl
    - {role: image-server, become: true}

- hosts: redhat-oss-git-stats.softwarefactory-project.io
  vars:
    xmx: 24g
    indexer_loop_delay: 60
    index_custom_html: "<h2>This instance of <a href='https://github.com/morucci/repoxplorer'>repoXplorer</a> indexes git repositories Red Hat is known to contribute to. The configuration is stored in this <a href='https://github.com/repoxplorer-rh/config'>repository</a>. If you want to propose new repositories or groups then do not hesitate to open a PR or an issue to that repository. For any other requests related to that platform please contact <a href='mailto:fboucher@redhat.com'>fboucher@redhat.com</a>.</h2>"
    indexer_skip_projects:
      - 'Fedora Distgits'
    users_endpoint: true
    repoxplorer_hostname: localhost
    service_public_hostname: redhat-oss-git-stats.softwarefactory-project.io
    github_client_id: 103305a2ab307037b8a4
    ssl_cert_options:
      cert1:
        email: "softwarefactory-operations-team@redhat.com"
        domain: "redhat-oss-git-stats.softwarefactory-project.io"
  roles:
    - hostname
    - elasticsearch
    - repoxplorer
    - repoxplorer-gateway
    - repoxplorer-rh-config
    - setup-ssl
    - node-exporter-rpm

- hosts: www.rdoproject.org
  roles:
    - hostname
    - node-exporter-rpm

- hosts: koji-vexxhost.softwarefactory-project.io
  roles:
    - node-exporter-rpm
