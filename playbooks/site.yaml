---
- hosts: bridge.softwarefactory-project.io
  gather_facts: yes
  pre_tasks:
    - name: Ensure hostname is correct
      hostname:
        name: bridge.softwarefactory-project.io
      become: yes
  roles:
    - bridge-accounts
    - generate-etc-hosts
  tasks:
    - name: "Install MTA"
      include_role:
        name: postfix
        apply:
          become: yes
      vars:
        myhostname: "{{ smtp_host }}"
        mydomain: "{{ smtp_domain }}"
        myorigin: "{{ smtp_host }}"
        mynetworks:
          - "{{ prometheus_public_ip }}/32"

- hosts:
    - zs.softwarefactory-project.io
    - nodepool-builder.softwarefactory-project.io
  tasks:
    - name: Update nodepool using master version (drop task after upgrade to sf-3.5)
      become: true
      package:
        name:
          - http://koji.softwarefactory-project.io/kojifiles/packages/python3-google-auth-httplib2/0.0.3/1.el7/noarch/python3-google-auth-httplib2-0.0.3-1.el7.noarch.rpm
          - http://koji.softwarefactory-project.io/kojifiles/packages/python3-google-api-python-client/1.7.11/1.el7/noarch/python3-google-api-python-client-1.7.11-1.el7.noarch.rpm
          - http://koji.softwarefactory-project.io/kojifiles/packages/nodepool/3.12.0/1.el7/noarch/nodepool-3.12.0-1.el7.noarch.rpm

- hosts: all:!osci_zone
  roles:
    - sf-infra-base

- hosts: all
  roles:
    - node-exporter

- hosts: backup
  vars_files:
    - vars/dlrn-db.yaml
  roles:
    - backup-monitoring
    - mysqld-exporter

- hosts: afs-mirror
  roles:
    - setup-ssl
    - afs-mirror
    - afs-monitoring

- hosts: logreduce-mqtt
  roles:
    - custom-exporter
    - logreduce-mqtt-worker
    - firewalld

# Temporary group until the migration is completed
- hosts: rdocloud-data-fetcher
  roles:
    - setup-rdocloud-ssh-access

- hosts: sf:rdo
  roles:
    - sf-ssh

- hosts: install-server
  roles:
    - hostname
#    - sf-install-server

- hosts: managesf.softwarefactory-project.io
  roles:
    - acme-tiny

- hosts: integrations.softwarefactory-project.io
  roles:
    - integrations

- hosts: prometheus.monitoring.softwarefactory-project.io
  pre_tasks:
    - name: Install requirements
      package:
        name:
          - podman
          - dnsmasq
      become: yes
  roles:
    - hostname
    - firewalld
    - setup-ssl
    - udp-multiplexer
    - monitoring-gateway
    - alert-manager
    - dnsmasq
    - grafana
    - blackbox-exporter
    - prometheus
    - pushprox
    - statsd-exporter

- hosts: zs.softwarefactory-project.io
  roles:
    - zuul_cli_access
    - stack-checks

- hosts: dlrn
  vars_files:
    - vars/dlrn.yaml
  roles:
    - firewalld
    - dlrn-server

- hosts: trunk.rdoproject.org
  roles:
    - rdotrunk-checks

- hosts:
    - trunk-centos7.rdoproject.org
    - trunk-centos8.rdoproject.org
    - centos8-rpm-packaging-ci.rdoproject.org
  roles:
    - swap

- hosts: logserver.rdoproject.org
  roles:
    - hostname
    - volume
    - logserver
    - setup-ssl

- hosts: images.rdoproject.org
  roles:
    - hostname
    - volume
    - setup-ssl
    - firewalld
    - {role: image-server, become: true}

- hosts: redhat-oss-git-stats.softwarefactory-project.io
  roles:
    - hostname
    - elasticsearch
    - repoxplorer
    - repoxplorer-gateway
    - repoxplorer-rh-config
    - setup-ssl

- hosts: www.rdoproject.org
  roles:
    - hostname
  tasks:
    - name: "Enable EPEL"
      package:
        name:
          - epel-release
      become: yes
    - name: "Deploy websites"
      include_role:
        name: websites
        tasks_from: vhosts
        apply:
          become: yes

# after www.rdoproject.org
- hosts: rdo-web-builder.int.osci.io
  roles:
    - hostname
  tasks:
    - name: "Enable EPEL"
      package:
        name:
          - epel-release
      become: yes
    # NOTE(jpena): We will be able to remove this task once the DNS entry
    # for www.rdoproject.org has been changed
    - name: Set IP for www.rdoproject.org in /etc/hosts
      become: yes
      lineinfile:
        dest: '/etc/hosts'
        regexp: ".+www.rdoproject.org.+$"
        line: "38.102.83.227 www.rdoproject.org"
    - name: "Deploy websites"
      include_role:
        name: websites
        tasks_from: builders
        apply:
          become: yes

- hosts: elk.*:nodepool-builder.softwarefactory-project.io
  roles:
    - volume

- hosts: nodepool-builder.softwarefactory-project.io
  roles:
    - manage-upstream-config-project

- hosts: dlrn-db.rdoproject.org
  vars_files:
    - vars/dlrn-db.yaml
  roles:
    - hostname
    - firewalld
    - mysqld-exporter
  tasks:
    - include_role:
        name: mariadb-replicated
        tasks_from: master.yml

- hosts: ci-centos-org
  become: yes
  roles:
    - pushprox
    - cico-agent

- name: Deploy and configure ARA API server
  hosts: ara.softwarefactory-project.io
  roles:
    - setup-ssl
    - ara-api-container

- hosts: koji.softwarefactory-project.io
  roles:
    - firewalld

- hosts: managesf.review.rdoproject.org
  roles:
    - acme-tiny

- hosts: ovirt.softwarefactory-project.io
  roles:
    - acme-tiny

- hosts: ovirt-staging.softwarefactory-project.io
  roles:
    - acme-tiny
