---
- hosts: bridge
  gather_facts: yes
  pre_tasks:
    - name: Ensure hostname is correct
      hostname:
        name: bridge.softwarefactory-project.io
      become: yes

    - name: Populate user ssh_known_hosts file when ansible port is not defined
      # syntax: hostname,ip key
      known_hosts:
        path: "~/.ssh/known_hosts"
        name: "{{ item }}"
        key: "{{ item }},{{ hostvars[item]['ansible_host'] }} ssh-ed25519 {{ hostvars[item]['ansible_ssh_host_key_ed25519_public'] }}"
      when: hostvars[item]['ansible_port'] is not defined
      loop: "{{ groups['all'] }}"

    - name: Populate user ssh_known_hosts file when ansible port is defined
      # syntax: [hostname]:port,[ip]:port key
      known_hosts:
        path: "~/.ssh/known_hosts"
        name: "[{{ item }}]:{{ hostvars[item]['ansible_port'] }}"
        key: "[{{ item }}]:{{ hostvars[item]['ansible_port'] }},[{{ hostvars[item]['ansible_host'] }}]:{{ hostvars[item]['ansible_port'] }} ssh-ed25519 {{ hostvars[item]['ansible_ssh_host_key_ed25519_public'] }}"
      when: hostvars[item]['ansible_port'] is defined
      loop: "{{ groups['all'] }}"
  roles:
    - bridge-accounts
    - postfix
    - node-exporter

- hosts: backup
  roles:
    - node-exporter-rpm
    - backup-monitoring

- hosts: afs-mirror
  roles:
    - afs-mirror
    - node-exporter-rpm
    - afs-monitoring

- hosts: logreduce-mqtt
  roles:
    - node-exporter
    - custom-exporter
    - logreduce-mqtt-worker

- hosts: prometheus
  pre_tasks:
    - name: Install requirements
      package:
        name:
          - podman
          - dnsmasq
      become: yes
  roles:
    - alert-manager
    - dnsmasq
    - grafana
    - node-exporter
    - blackbox-exporter
    - prometheus

- hosts: dlrn
  roles:
    - node-exporter-rpm
  tasks:
    - block:
        - name: Ensure firewalld is installed
          package:
            name: firewalld
        - name: Ensure firewalld service is running
          service:
            name: firewalld
            state: started
            enabled: yes
        - name: Enable port 9100 on firewall, it can be disabled by puppet-dlrn
          firewalld:
            port: 9100/tcp
            permanent: yes
            immediate: yes
            state: enabled
      become: yes

- hosts: trunk.rdoproject.org
  roles:
    - node-exporter-rpm
    - rdotrunk-checks

- hosts: trunk-centos8.rdoproject.org
  vars_files:
    - vars/dlrn.yaml
  roles:
    - dlrn-server

- hosts: centos8-rpm-packaging-ci.rdoproject.org
  roles:
    - swap
    - dlrn-server
