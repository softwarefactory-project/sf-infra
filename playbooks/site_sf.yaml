---
- import_playbook: site_bridge.yaml
- import_playbook: logreduce/site_logreduce.yaml

- hosts: microshift.softwarefactory-project.io
  tasks:
    - name: Read file with openshift_pull_secret
      ansible.builtin.include_vars:
        file: ~/.ansible_crc_vars.yaml
      no_log: yes
      delegate_to: localhost

    - name: Install microshift
      ansible.builtin.include_role:
        name: ~/src/github.com/openstack-k8s-operators/ansible-microshift-role

    - name: Fetch Kubeconfig from Microshift Host
      ansible.builtin.fetch:
        src: /var/lib/microshift/resources/kubeadmin/{{ ansible_fqdn }}/kubeconfig
        dest: /home/fedora/.kube/config
        mode: "0600"
        flat: yes
      become: true

    - name: Install Software Factory
      block:
        - name: Ensure Kubeconfig ownership
          ansible.builtin.file:
            path: /home/fedora/.kube/config
            owner: fedora
            group: fedora

        - name: Install origin-clients
          package:
            name: origin-clients
          become: yes

        - name: Install kubernetes.core collection
          ansible.builtin.command: >
            ansible-galaxy collection install kubernetes.core

        - name: Install Software Factory Catalog Source and Subscription
          ansible.builtin.include_role:
            name: sf/operator-catalog-sub

        - name: Copy Software Factory Manifest file
          ansible.builtin.copy:
            src: ../vars/infra-sf/sf_v1_softwarefactory.yaml
            dest: /tmp/sf_v1_softwarefactory.yaml

        - name: Install Software Factory
          kubernetes.core.k8s:
            state: present
            src: /tmp/sf_v1_softwarefactory.yaml
      delegate_to: localhost

- hosts: k1s
  roles:
    - sf/k1s
    - service/node-exporter

- hosts: sf
  roles:
    - infra/base
    - infra/ssh
    - service/node-exporter
    - system/update-host
    - system/podman

- hosts: backup-sf
  roles:
    - service/backup-client

- hosts: centos.softwarefactory-project.io
  roles:
    - service/acme-tiny
    - system/volume
    - service/apache-exporter
    - system/users

- hosts: image-builder.softwarefactory-project.io
  roles:
    - sf/image-builder
    - sf/podman-pruner
    # Keep in sync with zuul-weeder security group and prometheus dhall configuration
    - sf/zuul-weeder
    # next gen tasks will be done on that host: it does not do a lot,
    # and it has many free storage.
    - next-gen/prepare-host
    # Non extracted version
    - next-gen/crc-snapshot
    - next-gen/cleanup-openstack-resources
  tasks:
    - name: Create extracted CRC cronjob
      vars:
        crc_extracted_crc: true
      include_role:
        name: next-gen/crc-snapshot

- hosts: ze
  tasks:
    - name: Install rpmspec with rpm-build for Fedora Zuul CI zob
      yum:
        name: rpm-build
      become: yes

- hosts: managesf.softwarefactory-project.io
  roles:
    - infra/install-server
    - infra/ssh
    - service/acme-tiny
    - service/apache-exporter
    - service/hostname
  tasks:
    - name: Add monitoring subpage
      ansible.builtin.include_role:
        name: sf/monitoring-gateway
        tasks_from: vhost.yaml

- hosts: prometheus.monitoring.softwarefactory-project.io
  pre_tasks:
    - name: Install requirements
      package:
        name:
          - podman
          - dnsmasq
      become: yes
  roles:
    - service/firewalld
    - service/hostname
    - service/setup-ssl
    - sf/alert-manager
    - sf/blackbox-exporter
    - system/generate-etc-hosts
    - sf/dnsmasq
    - sf/grafana
    - sf/monitoring-gateway
    - sf/prometheus
    - sf/pushprox
    - sf/statsd-exporter
    - sf/udp-multiplexer
    - service/apache-exporter

- hosts: zs.softwarefactory-project.io
  roles:
    - sf/openstack-simply-reporter
    - sf/zuul_cli_access
    - sf/zookeeper-exporter

- hosts: elk.softwarefactory-project.io
  roles:
    - { name: "logscraper", become: true }
    - { name: "logsender", become: true }
    - service/opensearch-monitoring
    - system/volume

- hosts: fedora.softwarefactory-project.io
  roles:
    - service/acme-tiny
    - service/apache-exporter
    - sf/fm-gateway
    - system/volume

- hosts: nodepool-builder
  roles:
    - sf/builder-cleanup
    - sf/manage-upstream-config-project
    - system/volume

- hosts: koji.softwarefactory-project.io
  roles:
    - service/firewalld

- hosts: ansible.softwarefactory-project.io
  roles:
    - service/acme-tiny
    - service/apache-exporter

- hosts: logscraper01.openstack.org
  roles:
    - service/node-exporter

- hosts: ibm-baremetal-nodepool
  roles:
    - service/apache-exporter
    - sf/ca-trust

- hosts: ibm-instance
  roles:
    - sf/hostname
