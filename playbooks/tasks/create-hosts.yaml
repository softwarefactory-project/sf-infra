---
- name: Include tenant configuration
  ansible.builtin.include_vars:
    file: "{{ cloud.tenant | default(cloud.name) }}.yaml"
    name: tenant_config

- name: Get servers info
  openstack.cloud.server_info:
    cloud: "{{ cloud.name }}"
    auth:
      project_name: "{{ cloud.tenant | default(omit) }}"
  register: _cloud

- name: Create servers
  when: not (_cloud.servers | regex_search(server.name))
  openstack.cloud.server:
    cloud: "{{ cloud.name }}"
    auth:
      project_name: "{{ cloud.tenant | default(omit) }}"
    state: "{{ server.state | default('present') }}"
    name: "{{ server.name }}"
    image: "{{ server.image }}"
    flavor: "{{ server.flavor }}"
    key_name: "{{ server.key_name }}"
    network: "{{ server.network | default(None) }}"
    auto_ip: "{{ server.auto_ip | default(omit) }}"
    floating_ips: "{{ server.floating_ips | default(omit) }}"
    security_groups: "{{ server.security_groups | default('default') }}"
    boot_from_volume: "{{ server.boot_from_volume | default('no') }}"
    volume_size: "{{ server.volume_size | default(0) }}"
  loop: "{{ tenant_config.servers }}"
  loop_control:
    label: "{{ server.name }}"
    loop_var: server

- name: Create or delete additional volumes
  openstack.cloud.volume:
    cloud: "{{ cloud.name }}"
    auth:
      project_name: "{{ cloud.tenant | default(omit) }}"
    state: "{{ volume.state | default('present') }}"
    display_name: "{{ volume.display_name }}"
    size: "{{ volume.size }}"
    wait: yes
  loop: "{{ tenant_config.volumes }}"
  loop_control:
    label: "{{ volume.display_name }}"
    loop_var: volume

- name: Attach additional volumes
  openstack.cloud.server_volume:
    cloud: "{{ cloud.name }}"
    auth:
      project_name: "{{ cloud.tenant | default(omit) }}"
    state: "{{ volume.state | default('present') }}"
    volume: "{{ volume.display_name }}"
    server: "{{ volume.server }}"
    device: "{{ volume.device | default(omit) }}"
  loop: "{{ tenant_config.volumes }}"
  loop_control:
    label: "{{ volume.display_name }}"
    loop_var: volume
