---
- name: Include tenant configuration
  include_vars:
    file: "{{ cloud.tenant | default(cloud.name) }}.yaml"
    name: tenant_config

- name: Create servers
  os_server:
    cloud: "{{ cloud.name }}"
    auth:
      project_name: "{{ cloud.tenant | default(omit) }}"
    state: "{{ item.state | default('present') }}"
    name: "{{ item.name }}"
    image: "{{ item.image }}"
    flavor: "{{ item.flavor }}"
    key_name: "{{ item.key_name }}"
    network: "{{ item.network | default(None) }}"
    auto_ip: "{{ item.auto_ip | default(omit) }}"
    floating_ips: "{{ item.floating_ips | default(omit) }}"
    floating_ip_pools: "{{ item.floating_ip_pools | default(omit) }}"
    security_groups: "{{ item.security_groups | default('default') }}"
    boot_from_volume: "{{ item.boot_from_volume | default('no') }}"
    volume_size: "{{ item.volume_size | default(0) }}"
  loop: "{{ tenant_config.servers }}"
  loop_control:
    label: "{{ item.name }}"
  register: _servers

- name: Create additional volumes
  os_volume:
    cloud: "{{ cloud.name }}"
    auth:
      project_name: "{{ cloud.tenant | default(omit) }}"
    state: "{{ item.state | default('present') }}"
    display_name: "{{ item.display_name }}"
    size: "{{ item.size }}"
    wait: yes
  loop: "{{ tenant_config.volumes }}"

# Attaching volumes with os_server only works at initial server creation
# Use os_server_volume instead
- name: Attach additional volumes
  os_server_volume:
    cloud: "{{ cloud.name }}"
    auth:
      project_name: "{{ cloud.tenant | default(omit) }}"
    state: "{{ item.state | default('present') }}"
    volume: "{{ item.display_name }}"
    server: "{{ item.server }}"
    device: "{{ item.device | default(omit) }}"
  loop: "{{ tenant_config.volumes }}"

- name: Combine server ips fact
  become: true
  blockinfile:
    marker: ""
    block: |
      {% for server in _servers.results -%}
      {% set ipaddress = [] -%}
      {% set floating_address = [] -%}
      {% for network in available_networks -%}
      {% if network in server.server.addresses -%}
      {{- ipaddress.append(server.server.addresses[network] | selectattr('addr', 'defined') | selectattr('OS-EXT-IPS:type', 'match', 'fixed') | map(attribute='addr') | join('')) -}}
      {{- floating_address.append(server.server.addresses[network] | selectattr('addr', 'defined') | selectattr('OS-EXT-IPS:type', 'match', 'floating') | map(attribute='addr') | join('')) -}}
      {% endif -%}
      {% endfor -%}
      - name: {{ server.server.name }}
        ip: {{ ipaddress | first | default('') }}
        floating_ip: {{ floating_address | first | default('') }}
        project_name: {{ cloud.tenant | default(cloud.name) }}
      {% endfor %}
    path: "{{ temp_hosts_file }}"
