---
- semaphore:
    name: sf-infra
    max: 1

- job:
    name: dhall-diff
    description: Ensure running make is indempotent
    nodeset: fedora-latest-pod
    run: playbooks/dhall-diff.yaml

- job:
    name: prometheus-lint
    description: Lint prometheus configuration
    nodeset: fedora-latest-pod
    files:
      - roles/prometheus/files/.*.yaml
      - playbooks/prometheus-lint.yaml
    run: playbooks/prometheus-lint.yaml

- job:
    name: sf-infra-base
    abstract: true
    allowed-projects:
      - software-factory/sf-infra
    semaphore: sf-infra
    irrelevant-files:
      - "Makefile"
      - "package.dhall"
      - "playbooks/vars/.*.dhall"
      - "conf/.*"
    nodeset:
      # All infra playbook run from the bridge
      nodes: []

- job:
    name: sf-infra-create-bridge
    parent: sf-infra-base
    description: Deploy the bridge
    run: playbooks/create-bridge.yaml
    files:
      - ^playbooks/create-bridge.yaml$
    secrets:
      - name: cloud
        secret: vexxhost-cloud
    nodeset:
      # This special job needs to run from a container
      nodes:
        - name: container
          label: runc-centos-7

- job:
    name: sf-infra-configure-tenants
    parent: sf-infra-base
    description: Create the tenant resources such as network and secgroup
    dependencies:
      - name: sf-infra-create-bridge
        soft: true
    files:
      - ^playbooks/configure-tenants.yaml$
      - ^playbooks/vars/.*
      - ^tasks/configure-tenant.yaml$
      - ^roles/manage-networking/.*
      - ^roles/manage-image/.*
    run: playbooks/zuul/configure-hosts.yaml
    vars:
      sf_infra_play_name: configure-tenants

- job:
    name: sf-infra-create-hosts
    parent: sf-infra-base
    description: Create the hosts
    dependencies:
      - name: sf-infra-configure-tenants
        soft: true
    files:
      - ^playbooks/create-hosts.yaml$
      - ^playbooks/vars/.*
      - ^playbooks/tasks/create-hosts.yaml$
    run: playbooks/zuul/configure-hosts.yaml
    vars:
      sf_infra_play_name: create-hosts

- job:
    name: sf-infra-configure-hosts
    parent: sf-infra-base
    description: Configure the hosts
    dependencies:
      - name: sf-infra-create-hosts
        soft: true
    run: playbooks/zuul/configure-hosts.yaml
    required-projects:
      - review.rdoproject.org/rdo-infra/rdo-infra-playbooks
    vars:
      sf_infra_play_name: site
    secrets:
      - name: cloud
        secret: vexxhost-cloud
      - name: vault
        secret: ansible-vault

- job:
    name: sf-infra-configure-registry
    parent: sf-infra-base
    description: Configure the registry host
    dependencies:
      - name: sf-infra-create-hosts
        soft: true
    run: playbooks/zuul/configure-registry-host.yaml
    required-projects:
      - name: review.rdoproject.org/rdo-infra/rdo-infra-playbooks
      # NOTE(dpawlik) rdo-3.11 branch include cockpit patch.
      # Official branch is: release-3.11
      - name: github.com/rdo-infra/openshift-ansible
        override-checkout: rdo-3.11-dns-mismatch-updated
    files:
      - ^playbooks/rdo-registry.yaml$
      - ^playbooks/zuul/configure-registry-host.yaml$
      - ^playbooks/host_vars/registry-vexxhost.rdoproject.org.yml$
    secrets:
      - name: cloud
        secret: vexxhost-cloud
      - name: vault
        secret: ansible-vault

- job:
    name: sf-infra-molecule
    parent: sf-infra-base
    description: Use molecule to test Ansible roles
    pre-run: tests/pre-tox-molecule.yml
    run: tests/tox-molecule.yml
    post-run: tests/post-tox-molecule.yml
    timeout: 3600
    nodeset:
      nodes:
        - name: primary
          label: cloud-fedora-30
    files:
      - ^roles/rdotrunk-checks/.*$
      - ^roles/backup-monitoring/.*$
      - ^roles/swap/.*$
      - ^roles/dlrn-server/.*$
      - ^roles/afs-monitoring/.*$
      - ^roles/elasticsearch/.*$
      - ^roles/repoxplorer/.*$
      - ^roles/repoxplorer-gateway/.*$
      - ^roles/custom-ssh-port/.*$
      - ^roles/mariadb-replicated/.*$
      - ^roles/firewalld/.*$
      - ^tox.ini$
      - ^tests/.*molecule.yml$

- project:
    check:
      jobs:
        - linters:
            nodeset: fedora-latest-pod
            vars:
              linters:
                - flake8
                - yamllint
        - dhall-diff
        - prometheus-lint
        - sf-infra-molecule
    gate:
      jobs:
        - linters:
            nodeset: fedora-latest-pod
            vars:
              linters:
                - flake8
                - yamllint
        - dhall-diff
        - sf-infra-create-bridge
        - sf-infra-create-hosts
        - sf-infra-configure-tenants
        - sf-infra-configure-hosts
        - sf-infra-configure-registry
