---
- semaphore:
    name: sf-infra
    max: 1

- job:
    name: prometheus-lint
    description: Lint prometheus configuration
    nodeset: linters-pod
    files:
      - monitoring/.*
      - playbooks/prometheus-lint.yaml
    run: playbooks/prometheus-lint.yaml

- job:
    name: sf-infra-base
    abstract: true
    allowed-projects:
      - software-factory/sf-infra
      - review.rdoproject.org/rdo-infra/rdo-infra-playbooks
    irrelevant-files:
      - "Makefile"
      - ".*.dhall"
    nodeset:
      # All infra playbook run from the bridge
      nodes: []

- job:
    name: sf-infra-create-bridge
    parent: sf-infra-base
    description: Deploy the bridge
    semaphore: sf-infra
    run: playbooks/create-bridge.yaml
    files:
      - ^playbooks/create-bridge.yaml$
    secrets:
      - name: cloud
        secret: vexxhost-cloud
    nodeset:
      # This special job needs to run from a container
      nodes:
        - name: container
          label: pod-centos-8

- job:
    name: sf-infra-configure-tenants
    parent: sf-infra-base
    description: Create the tenant resources such as network and secgroup
    semaphore: sf-infra
    dependencies:
      - name: sf-infra-create-bridge
        soft: true
    files:
      - ^playbooks/configure-tenants.yaml$
      - ^playbooks/vars/.*
      - ^tasks/configure-tenant.yaml$
      - ^roles/manage-networking/.*
      - ^roles/manage-image/.*
    run: playbooks/zuul/configure-hosts.yaml
    vars:
      sf_infra_play_name: configure-tenants
    secrets:
      - name: ara_api
        secret: bridge_ara_api

- job:
    name: sf-infra-create-hosts
    parent: sf-infra-base
    description: Create the hosts
    semaphore: sf-infra
    dependencies:
      - name: sf-infra-configure-tenants
        soft: true
    files:
      - ^playbooks/create-hosts.yaml$
      - ^playbooks/vars/.*
      - ^playbooks/tasks/create-hosts.yaml$
    run: playbooks/zuul/configure-hosts.yaml
    vars:
      sf_infra_play_name: create-hosts
    secrets:
      - name: ara_api
        secret: bridge_ara_api

# NOTE: This job will be removed in the future.
- job:
    name: sf-infra-configure-hosts
    parent: sf-infra-base
    description: Configure the hosts
    semaphore: sf-infra
    dependencies:
      - name: sf-infra-create-hosts
        soft: true
    run: playbooks/zuul/configure-hosts.yaml
    required-projects:
      - name: review.rdoproject.org/rdo-infra/rdo-infra-playbooks
      - name: review.rdoproject.org/rdo-infra/ansible-role-dlrn
      - name: software-factory/sf-infra
      - name: software-factory/ansible-role-elastic-recheck
    timeout: 3600
    vars:
      sf_infra_play_name: site
      fetch_galaxy_role: True
    secrets:
      - name: cloud
        secret: vexxhost-cloud
      - name: vault
        secret: ansible-vault
      - name: ara_api
        secret: bridge_ara_api
      - name: sshkey
        secret: bridge_ssh_key

- job:
    name: sf-infra-configure-hosts-dlrn
    parent: sf-infra-configure-hosts
    description: Configure the DLRN hosts
    dependencies:
      - name: sf-infra-configure-hosts
        soft: true
    timeout: 3600
    vars:
      sf_infra_play_name: site_dlrn
      fetch_galaxy_role: True
    files:
      - ^playbooks/vars/dlrn.yaml$
      - ^playbooks/vars/dlrn-db.yaml$
      - ^playbooks/host_vars/dlrn-db.rdoproject.org.yaml$
      - ^playbooks/host_vars/trunk-centos8.rdoproject.org.yaml$
      - ^playbooks/host_vars/trunk.rdoproject.org.yaml$
      - ^playbooks/group_vars/dlrn$
      - ^playbooks/site_dlrn.yaml$
      - ^roles/dlrn-server.*
      - ^monitoring/rules-dlrn.yaml

- job:
    name: sf-infra-configure-hosts-rdo
    parent: sf-infra-base
    description: Configure the RDO infra hosts
    semaphore: sf-infra
    dependencies:
      - name: sf-infra-create-hosts
        soft: true
    run: playbooks/zuul/configure-hosts.yaml
    required-projects:
      - name: review.rdoproject.org/rdo-infra/rdo-infra-playbooks
      - name: review.rdoproject.org/rdo-infra/ansible-role-dlrn
      - name: software-factory/sf-infra
      - name: software-factory/ansible-role-elastic-recheck
    timeout: 3600
    vars:
      sf_infra_play_name: site_rdo
      fetch_galaxy_role: True
    secrets:
      - name: cloud
        secret: vexxhost-cloud
      - name: vault
        secret: ansible-vault
      - name: ara_api
        secret: bridge_ara_api

- job:
    name: sf-infra-configure-hosts-sf
    parent: sf-infra-base
    description: Configure the sf.io hosts
    semaphore: sf-infra
    dependencies:
      - name: sf-infra-create-hosts
        soft: true
    run: playbooks/zuul/configure-hosts.yaml
    required-projects:
      - name: software-factory/sf-infra
    timeout: 3600
    vars:
      sf_infra_play_name: site_sf
      fetch_galaxy_role: False
    secrets:
      - name: cloud
        secret: vexxhost-cloud
      - name: vault
        secret: ansible-vault
      - name: ara_api
        secret: bridge_ara_api

- job:
    name: sf-infra-configure-registry
    parent: sf-infra-base
    description: Configure the registry host
    semaphore: sf-infra
    dependencies:
      - name: sf-infra-create-hosts
        soft: true
    run: playbooks/zuul/configure-registry-host.yaml
    required-projects:
      - name: review.rdoproject.org/rdo-infra/rdo-infra-playbooks
      - name: software-factory/sf-infra
      # NOTE(dpawlik) rdo-3.11 branch include cockpit patch.
      # Official branch is: release-3.11
      - name: github.com/rdo-infra/openshift-ansible
        override-checkout: rdo-3.11-dns-mismatch-updated
    files:
      - ^playbooks/rdo-registry.yaml$
      - ^playbooks/zuul/configure-registry-host.yaml$
      - ^playbooks/host_vars/registry.rdoproject.org.yml$
    secrets:
      - name: cloud
        secret: vexxhost-cloud
      - name: vault
        secret: ansible-vault
      - name: ara_api
        secret: bridge_ara_api

- job:
    name: sf-infra-configure-quay
    parent: sf-infra-base
    description: Configure the Quay host
    semaphore: sf-infra
    dependencies:
      - name: sf-infra-create-hosts
        soft: true
    run: playbooks/zuul/configure-quay-host.yaml
    required-projects:
      - name: software-factory/sf-infra
    files:
      - ^playbooks/quay-renew-certificates.yml$
      - ^playbooks/zuul/configure-quay-host.yaml$
    secrets:
      - name: cloud
        secret: vexxhost-cloud
      - name: vault
        secret: ansible-vault
      - name: ara_api
        secret: bridge_ara_api

- job:
    name: sf-infra-molecule
    parent: sf-infra-base
    description: Use molecule to test Ansible roles
    pre-run: tests/pre-tox-molecule.yml
    run: tests/tox-molecule.yml
    post-run: tests/post-tox-molecule.yml
    required-projects:
      - name: software-factory/sf-infra
    timeout: 7200
    nodeset:
      nodes:
        - name: primary
          label: rdo-centos-stream
    files:
      - ^roles/backup-monitoring/.*$
      - ^roles/swap/.*$
      - ^roles/dlrn-server/.*$
      - ^roles/afs-monitoring/.*$
      - ^roles/elasticsearch/.*$
      - ^roles/custom-ssh-port/.*$
      - ^roles/mariadb-replicated/.*$
      - ^roles/firewalld/.*$
      - ^roles/pushprox/.*$
      - ^tox.ini$
      - ^tests/.*molecule.yml$
      - ^zuul.d/jobs.yaml$

- job:
    name: sf-infra-grafana-dashboards
    parent: sf-infra-base
    description: Deploy Grafana and take screenshots of all dashboards
    pre-run: tests/pre-grafana-dash.yml
    run: tests/grafana-dash.yml
    post-run: tests/post-grafana-dash.yml
    required-projects:
      - name: software-factory/sf-infra
    nodeset:
      nodes:
        - name: primary
          label: rdo-centos-stream
    files:
      - ^roles/grafana/.*$
      - ^tests/grafana-dash.yml$
      - ^tests/post-grafana-dash.yml$
      - ^tests/pre-grafana-dash.yml$
      - ^tests/templates/grafana-screenshots.js.j2$

- project:
    check:
      jobs:
        - sf-infra-test-udp-multiplexer
        - sf-infra-test-custom-exporter
        - linters:
            nodeset: linters-pod
            vars:
              linters:
                - flake8
                - yamllint
        - dhall-diff: &dhall-nodeset
            nodeset:
              nodes:
                - name: container
                  label: zuul-worker-dhall
        - prometheus-lint
        - sf-infra-molecule
        - sf-infra-grafana-dashboards
        - shake-factory-docs:
            files:
              - ^Infra/.*$
    gate:
      jobs:
        - sf-infra-test-udp-multiplexer
        - sf-infra-test-custom-exporter
        - linters:
            nodeset: linters-pod
            vars:
              linters:
                - flake8
                - yamllint
        - dhall-diff: *dhall-nodeset
        - shake-factory-docs:
            files:
              - ^Infra/.*$
        - sf-infra-create-bridge:
            dependencies:
              - dhall-diff
        - sf-infra-create-hosts:
            dependencies:
              - dhall-diff
        - sf-infra-configure-tenants:
            dependencies:
              - dhall-diff
        - sf-infra-configure-hosts:
            dependencies:
              - dhall-diff
        - sf-infra-configure-hosts-dlrn:
            dependencies:
              - dhall-diff
        - sf-infra-configure-registry:
            dependencies:
              - dhall-diff
        - sf-infra-configure-quay:
            dependencies:
              - dhall-diff
