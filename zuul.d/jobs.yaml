---
- semaphore:
    name: sf-infra
    max: 1

- job:
    name: prometheus-lint
    description: Lint prometheus configuration
    nodeset: linters-pod
    files:
      - monitoring/.*
      - playbooks/prometheus-lint.yaml
    run: playbooks/prometheus-lint.yaml

- job:
    name: sf-infra-base
    abstract: true
    allowed-projects:
      - software-factory/sf-infra
      - review.rdoproject.org/rdo-infra/rdo-infra-playbooks
    timeout: 7200
    irrelevant-files:
      - "Makefile"
      - ".*.dhall"
    nodeset:
      # All infra playbook run from the bridge
      nodes: []

- job:
    name: sf-infra-create-bridge
    parent: sf-infra-base
    description: Deploy the bridge
    semaphore: sf-infra
    run: playbooks/create-bridge.yaml
    files:
      - ^playbooks/create-bridge.yaml$
    secrets:
      - name: vexxhost_rdo
        secret: vexxhost-rdo
      - name: ibm_bm3_nodepool
        secret: ibm-bm3-nodepool
    nodeset:
      # This special job needs to run from a container
      nodes:
        - name: container
          label: pod-centos-8-stream

- job:
    name: sf-infra-configure-tenants
    parent: sf-infra-base
    description: Create the tenant resources such as network and secgroup
    semaphore: sf-infra
    files:
      - ^playbooks/configure-tenants.yaml$
      - ^playbooks/vars/.*
      - ^tasks/configure-tenant.yaml$
      - ^roles/manage-networking/.*
      - ^roles/manage-image/.*
    run: playbooks/zuul/configure-hosts.yaml
    vars:
      sf_infra_play_name: configure-tenants
    secrets:
      - name: vexxhost_rdo
        secret: vexxhost-rdo
      - name: ibm_bm3_nodepool
        secret: ibm-bm3-nodepool

- job:
    name: sf-infra-create-hosts
    parent: sf-infra-base
    description: Create the hosts
    semaphore: sf-infra
    files:
      - ^playbooks/create-hosts.yaml$
      - ^playbooks/vars/.*
      - ^playbooks/tasks/create-hosts.yaml$
    run: playbooks/zuul/configure-hosts.yaml
    vars:
      sf_infra_play_name: create-hosts
    secrets:
      - name: vexxhost_rdo
        secret: vexxhost-rdo
      - name: ibm_bm3_nodepool
        secret: ibm-bm3-nodepool

- job:
    name: sf-infra-configure
    parent: sf-infra-base
    abstract: true
    semaphore: sf-infra
    description: Base job to configure hosts
    run: playbooks/zuul/configure-hosts.yaml
    required-projects:
      - name: review.rdoproject.org/rdo-infra/rdo-infra-playbooks
      - name: review.rdoproject.org/rdo-infra/ansible-role-dlrn
      - name: software-factory/sf-infra
      - name: software-factory/ansible-role-elastic-recheck
      - name: opendev.org/openstack/ci-log-processing
    timeout: 3600
    vars:
      sf_infra_play_name: site
      fetch_galaxy_role: True
    secrets:
      - name: vexxhost_rdo
        secret: vexxhost-rdo
      - name: ibm_bm3_nodepool
        secret: ibm-bm3-nodepool
      - name: vault
        secret: ansible-vault
      - name: sshkey
        secret: bridge_ssh_key

- job:
    name: sf-infra-configure-hosts-dlrn
    parent: sf-infra-configure
    description: Configure the DLRN hosts
    vars:
      sf_infra_play_name: site_dlrn
    files:
      - playbooks/site_dlrn.yaml
      - playbooks/host_vars/dlrn-db.rdoproject.org.yaml
      - ^playbooks/host_vars/trunk.*.yaml$
      - playbooks/group_vars/all
      - playbooks/group_vars/dlrn
      - "^roles/infra/.*$"
      - "^roles/service/.*$"
      - "^roles/system/.*$"
      - "^roles/dlrn/.*$"

- job:
    name: sf-infra-configure-hosts-osci
    parent: sf-infra-configure
    description: Configure the OSCI hosts
    vars:
      sf_infra_play_name: site_osci
    files:
      - playbooks/site_osci.yaml
      - "^playbooks/host_vars/lists.rdoproject.org/.*$"
      - "^playbooks/host_vars/rdo-web-builder.int.osci.io/.*$"
      - "^playbooks/host_vars/www.rdoproject.org/.*$"
      - "^playbooks/group_vars/osci_internal_zone/.*$"
      - "^playbooks/group_vars/osci_zone/.*$"
      - "^roles/infra/.*$"
      - "^roles/service/.*$"
      - "^roles/system/.*$"
      - "^roles/osci/.*$"
- job:
    name: sf-infra-configure-hosts-rdo
    parent: sf-infra-configure
    description: Configure the RDO infra hosts
    vars:
      sf_infra_play_name: site_rdo
    files:
      - playbooks/site_rdo.yaml
      - ^playbooks/host_vars/.*rdoproject.org.ya?ml$
      - playbooks/host_vars/rdo-web-builder.int.osci.io
      - playbooks/group_vars/all
      - playbooks/group_vars/osci_internal_zone
      - playbooks/group_vars/osci_zone
      - playbooks/group_vars/rdo.yaml
      - "^roles/infra/.*$"
      - "^roles/service/.*$"
      - "^roles/system/.*$"
      - "^roles/rdo/.*$"

- job:
    name: sf-infra-configure-hosts-sf
    parent: sf-infra-configure
    description: Configure the sf.io hosts
    vars:
      sf_infra_play_name: site_sf
    files:
      - playbooks/site_sf.yaml
      - ^playbooks/host_vars/.*softwarefactory-project.io.ya?ml$
      - playbooks/group_vars/all
      - playbooks/group_vars/k1s.yaml
      - playbooks/group_vars/logreduce-mqtt
      - playbooks/group_vars/nodepool-builder.yaml
      - playbooks/group_vars/sf.yaml
      - "^monitoring/.*yaml$"
      - "^roles/infra/.*$"
      - "^roles/service/.*$"
      - "^roles/system/.*$"
      - "^roles/sf/.*$"

- job:
    name: sf-infra-create-tripleo-standalone
    parent: sf-infra-base
    description: Install tripleo-standalone on ibm baremetal
    semaphore: sf-infra
    run: playbooks/zuul/create-tripleo-standalone.yaml
    timeout: 3600
    files:
      - ^playbooks/zuul/create-tripleo-standalone.yaml$
      - ^playbooks/zuul/configure-private-clouds.yaml$
      - ^playbooks/zuul/tasks/standalone-setup.yaml$
      - ^playbooks/zuul/templates/local-overrides.yaml.j2$
      - ^playbooks/zuul/host_vars/bridge.softwarefactory-project.io.yaml$
      - ^playbooks/zuul/group_vars/baremetal.yaml$
    secrets:
      - name: ibm_bm3_nodepool
        secret: ibm-bm3-nodepool

- job:
    name: sf-infra-configure-tripleo-standalone
    parent: sf-infra-base
    description: Install tripleo-standalone on ibm baremetal
    semaphore: sf-infra
    run: playbooks/zuul/configure-tripleo-standalone.yaml
    timeout: 3600
    files:
      - ^playbooks/zuul/configure-tripleo-standalone.yaml$
      - ^playbooks/zuul/tasks/standalone-configure.yaml$
      - ^playbooks/zuul/host_vars/bridge.softwarefactory-project.io.yaml$
    secrets:
      - name: ibm_bm3_nodepool
        secret: ibm-bm3-nodepool

- job:
    name: sf-infra-configure-quay
    parent: sf-infra-base
    description: Configure the Quay host
    semaphore: sf-infra
    run: playbooks/zuul/configure-quay-host.yaml
    required-projects:
      - name: software-factory/sf-infra
    files:
      - ^playbooks/quay-renew-certificates.yml$
      - ^playbooks/zuul/configure-quay-host.yaml$
    secrets:
      - name: vexxhost_rdo
        secret: vexxhost-rdo
      - name: ibm_bm3_nodepool
        secret: ibm-bm3-nodepool
      - name: vault
        secret: ansible-vault

- job:
    name: sf-infra-molecule
    parent: sf-infra-base
    description: Use molecule to test Ansible roles
    pre-run: tests/pre-tox-molecule.yml
    run: tests/tox-molecule.yml
    post-run: tests/post-tox-molecule.yml
    required-projects:
      - name: software-factory/sf-infra
    timeout: 7200
    nodeset:
      nodes:
        - name: primary
          label: rdo-centos-stream
    files:
      - ^roles/dlrn/dlrn-server/.*$
      - ^roles/drln/mariadb-replicated/.*$
      - ^roles/rdo/afs-monitoring/.*$
      - ^roles/rdo/backup-monitoring/.*$
      - ^roles/service/firewalld/.*$
      - ^roles/service/opensearch-monitoring/.*$
      - ^roles/sf/pushprox/.*$
      - ^roles/system/swap/.*$
      - ^tests/.*molecule.yml$
      - ^tox.ini$

- job:
    name: sf-infra-grafana-dashboards
    parent: sf-infra-base
    description: Deploy Grafana and take screenshots of all dashboards
    pre-run: tests/pre-grafana-dash.yml
    run: tests/grafana-dash.yml
    post-run: tests/post-grafana-dash.yml
    required-projects:
      - name: software-factory/sf-infra
    nodeset:
      nodes:
        - name: primary
          label: cloud-centos-8-stream
    files:
      - ^roles/sf/grafana/.*$
      - ^tests/grafana-dash.yml$
      - ^tests/post-grafana-dash.yml$
      - ^tests/pre-grafana-dash.yml$
      - ^tests/templates/grafana-screenshots.js.j2$

- job:
    name: sf-infra-quay-check
    description: Deploy Quay service and check basic functionality
    run: tests/check-quay-tool.yml
    required-projects:
      - name: software-factory/python-quay-tool
    timeout: 1800
    files:
      - ^roles/rdo/quay/.*$
    nodeset:
      nodes:
        - name: quay.dev
          label: cloud-centos-8-stream

- project:
    check:
      jobs:
        - sf-infra-test-udp-multiplexer
        - sf-infra-test-custom-exporter
        - linters:
            nodeset: linters-pod
            vars:
              linters:
                - flake8
                - yamllint
        - dhall-diff: &dhall-nodeset
            nodeset:
              nodes:
                - name: container
                  label: zuul-worker-dhall
        - prometheus-lint
        - sf-infra-molecule
        - sf-infra-grafana-dashboards:
            files:
              - "^roles/sf/grafana/.*$"
              - "^tests/grafana-dash.yml$"
              - "^tests/post-grafana-dash.yml$"
              - "^tests/pre-grafana-dash.yml$"
              - "^tests/templates/grafana-screenshots.js.j2$"
        - sf-infra-quay-check
    gate:
      jobs:
        - sf-infra-test-udp-multiplexer
        - sf-infra-test-custom-exporter
        - linters:
            nodeset: linters-pod
            vars:
              linters:
                - flake8
                - yamllint
        - dhall-diff: *dhall-nodeset
        - sf-infra-create-bridge:
            dependencies:
              - dhall-diff
        - sf-infra-configure-tenants:
            dependencies:
              - dhall-diff
              - name: sf-infra-create-bridge
                soft: true
        - sf-infra-create-hosts:
            dependencies:
              - dhall-diff
              - name: sf-infra-configure-tenants
                soft: true
        - sf-infra-configure-hosts-sf:
            dependencies:
              - dhall-diff
              - name: sf-infra-create-hosts
                soft: true
        - sf-infra-configure-hosts-rdo:
            dependencies:
              - dhall-diff
              - name: sf-infra-create-hosts
                soft: true
        - sf-infra-configure-hosts-dlrn:
            dependencies:
              - dhall-diff
              - name: sf-infra-create-hosts
                soft: true
        - sf-infra-configure-hosts-osci:
            dependencies:
              - dhall-diff
              - name: sf-infra-create-hosts
                soft: true
        - sf-infra-create-tripleo-standalone:
            dependencies:
              - dhall-diff
              - name: sf-infra-create-hosts
                soft: true
        - sf-infra-configure-tripleo-standalone:
            dependencies:
              - dhall-diff
              - name: sf-infra-create-tripleo-standalone
                soft: true
        - sf-infra-configure-quay:
            dependencies:
              - dhall-diff
              - name: sf-infra-create-hosts
                soft: true
