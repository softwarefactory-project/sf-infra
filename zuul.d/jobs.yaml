---
- semaphore:
    name: sf-infra
    max: 1

- job:
    name: sf-infra-base
    abstract: true
    allowed-projects:
      - software-factory/sf-infra
    semaphore: sf-infra
    nodeset:
      # All infra playbook run from the bridge
      nodes: []

- job:
    name: sf-infra-create-bridge
    parent: sf-infra-base
    description: Deploy the bridge
    run: playbooks/create-bridge.yaml
    files:
      - ^playbooks/create-bridge.yaml$
    secrets:
      - name: cloud
        secret: vexxhost-cloud
    nodeset:
      # This special job needs to run from a container
      nodes:
        - name: container
          label: runc-centos-7

- job:
    name: sf-infra-configure-tenants
    parent: sf-infra-base
    description: Create the tenant resources such as network and secgroup
    dependencies:
      - name: sf-infra-create-bridge
        soft: true
    files:
      - ^playbooks/configure-tenants.yaml$
      - ^playbooks/vars/.*
      - ^tasks/configure-tenant.yaml$
      - ^roles/manage-networking/.*
      - ^roles/manage-image/.*
    run: playbooks/configure-hosts.yaml
    vars:
      sf_infra_play_name: configure-tenants

- job:
    name: sf-infra-create-hosts
    parent: sf-infra-base
    description: Create the hosts
    dependencies:
      - name: sf-infra-configure-tenants
        soft: true
    files:
      - ^playbooks/create-hosts.yaml$
      - ^playbooks/vars/.*
      - ^playbooks/tasks/create-hosts.yaml$
    run: playbooks/configure-hosts.yaml
    vars:
      sf_infra_play_name: create-hosts

- job:
    name: sf-infra-configure-hosts
    parent: sf-infra-base
    description: Configure the hosts
    dependencies:
      - name: sf-infra-create-hosts
        soft: true
    run: playbooks/configure-hosts.yaml
    vars:
      sf_infra_play_name: site
    secrets:
      - name: cloud
        secret: vexxhost-cloud
      - name: vault
        secret: ansible-vault

- project:
    check:
      jobs:
        - linters:
            vars:
              linters:
                # Uncomment once linters job use python3 flake8
                # - flake8
                - yamllint
    gate:
      jobs:
        - sf-infra-create-bridge
        - sf-infra-create-hosts
        - sf-infra-configure-tenants
        - sf-infra-configure-hosts
