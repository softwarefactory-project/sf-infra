---
- hosts: all
  tasks:
    - name: Generate dummy ansible_vault file
      copy:
        content: |
          test
        dest: '{{ ansible_user_dir }}/.ansible_vault'

    - name: Generate simple playbook to deploy Grafana
      copy:
        content: |
          ---
          - hosts: localhost
            vars:
              grafana_server_root_url: http://localhost
              prometheus_public_url: "http://prometheus.monitoring.rdoproject.org/prometheus"
              # Grafana 9.2.6
              container_images:
                grafana: "quay.io/software-factory/grafana-oss@sha256:1016f0f2612877830ab8f74acbc937fafad9df0b9db1c58c353aea3afd080e40"
            roles:
              - sf/grafana
        dest: '{{ ansible_user_dir }}/deploy_grafana.yml'

    - name: Deploy Grafana locally
      shell:
        cmd: |
          ansible-playbook deploy_grafana.yml
      environment:
        ANSIBLE_CONFIG: "{{ ansible_user_dir }}/{{ zuul.projects['softwarefactory-project.io/software-factory/sf-infra'].src_dir }}/ansible"

    - name: Install puppeteer
      shell: |
          npm install puppeteer@20.2.1
      args:
        chdir: "{{ ansible_user_dir }}"

    - name: Create required dirs for Grafana
      file:
        path: "/etc/grafana/provisioning/{{ item  }}"
        state: directory
      loop:
        - dashboards
        - datasources
        - plugins
      become: true

    - name: Find all dashboards
      shell:
        cmd: |
          find /etc/grafana/provisioning/dashboards/infra/ -type f -name '*.json' -print0 | xargs -0 -I {} jq -r .title {}
      register: dashboard_names

    - set_fact:
        dashboards: "{{ dashboard_names.stdout.split('\n') }}"

    - name: Deploy puppeteer script
      template:
        src: grafana-screenshots.js.j2
        dest: '{{ ansible_user_dir }}/test.js'
        mode: 0755

    - name: Create log directory
      file:
        path: '{{ ansible_user_dir }}/log'
        state: directory
        mode: '0755'

    - name: Run puppeteer script
      shell:
        cmd: |
          node test.js
        chdir: "{{ ansible_user_dir }}"
