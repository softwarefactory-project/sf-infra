---
- name: Configure service
  become: yes
  block:
    - name: Install epel-release and git
      package:
        name:
          - epel-release
          - git

    - name: Deploy temporary repo for CentOS 8
      copy:
        src: puppet-repo-centos8.repo
        dest: /etc/yum.repos.d/puppet-repo.repo
      when:
        - ansible_distribution == "CentOS"
        - ansible_distribution_major_version == '8'

    - name: Deploy temporary repo for CentOS 7
      copy:
        src: puppet-repo-centos7.repo
        dest: /etc/yum.repos.d/puppet-repo.repo
      when:
        - ansible_distribution == "CentOS"
        - ansible_distribution_major_version == '7'

    - name: Install puppet from temporary repo
      yum:
        name:
          - puppet
          - rubygem-multi_json
          - 'leatherman < 1.10'
        enablerepo: "puppet-temporary-repo"

    - name: Copy puppet-dlrn from local checkout
      copy:
        src: "{{ puppet_dlrn_path }}"
        dest: '/root/puppet-dlrn'
      register: copy_status
      when:
        - puppet_dlrn_path is defined
        - puppet_dlrn_path | length > 0

    - name: Clone puppet-dlrn
      git:
        repo: 'https://github.com/rdo-infra/puppet-dlrn'
        dest: '/root/puppet-dlrn'
        version: master
        force: yes
      register: git_status
      when:
        - (puppet_dlrn_path is not defined) or puppet_dlrn_path | length == 0

    - name: Apply override files, if needed
      copy:
        src: "{{ item.value.source }}"
        dest: "{{ item.key }}"
      with_dict: "{{ dlrn_override_files }}"
      when:
        - dlrn_override_files is defined
      register: overrides

    - name: Build puppet module
      shell:
        cmd: |
          puppet module build
        chdir: '/root/puppet-dlrn'
      when: git_status.changed or overrides.changed or copy_status.changed

    - name: Check if puppet module is already installed
      stat:
        path: '/etc/puppet/modules/dlrn'
      register: puppetmodule

    - name: Uninstall previous version of puppet module
      shell:
        cmd: |
          puppet module uninstall --force jpena-dlrn
      when:
        - puppetmodule.stat.exists
        - git_status.changed or overrides.changed or copy_status.changed

    - name: Install puppet module
      shell:
        cmd: |
          puppet module install /root/puppet-dlrn/pkg/*.tar.gz
      when: git_status.changed or overrides.changed or copy_status.changed

    - name: Configure hiera for Puppet
      copy:
        src: hiera.yaml
        dest: /etc/puppet/hiera.yaml

    - name: Set up hiera file
      template:
        src: "{{ dlrn_host }}-common.yaml"
        dest: /var/lib/hiera/common.yaml

    - name: Install puppet manifest
      template:
        src: site.pp.j2
        dest: /root/site.pp

    - name: Apply puppet manifest
      command: puppet apply /root/site.pp
      # The puppet module execution is not perfectly idempotent,
      # so we need this to keep molecule happy
      changed_when: false

    - name: Create directories for MySQL SSL client certs
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      with_items:
        - /etc/mysql
        - /etc/mysql/ssl

    - name: Deploy client-cert.pem
      copy:
        content: "{{ client_cert }}"
        dest: /etc/mysql/ssl/client-cert.pem
        mode: '0644'
      when: client_cert is defined

    - name: Deploy client-key.pem
      copy:
        content: "{{ client_key }}"
        dest: /etc/mysql/ssl/client-key.pem
        mode: '0644'
      when: client_key is defined

    - name: Create DLRN admin users
      include_role:
        name: base
        tasks_from: users.yml
      vars:
        rdo_admin_group: "{{ rdo_dlrn_admin_group }}"
        rdo_admin_users: "{{ rdo_dlrn_admin_users }}"
