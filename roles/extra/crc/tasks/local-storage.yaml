---
- name: Configure host for sf-operator
  block:
    - name: Get home directory
      shell: |
        getent passwd "{{ ansible_user }}" | cut -d: -f6
      register: user_home

    - name: Copy oc binary
      become: true
      copy:
        src: "{{ user_home.stdout }}/.crc/bin/oc/oc"
        dest: "/usr/local/bin/oc"
        mode: "0755"
        remote_src: true

    - name: Ensure that oc is logged into Openshift
      shell: >
        /usr/local/bin/oc login
        -u kubeadmin -p "{{ openshift_admin_password }}"
        https://api.crc.testing:6443 --insecure-skip-tls-verify=true
      until: "'Unable to connect to the server' not in _login_user.stderr"
      retries: 20
      delay: 10
      register: _login_user

    - name: Get openstack install yaml repository
      git:
        repo: https://github.com/openstack-k8s-operators/install_yamls
        dest: install_yamls
        version: 62a3d19a9a38cc168bd4cc893529ce41ab6278f5

    - name: Replace local-storage with standard storageclass
      shell: |
        find . -type f -exec sed -i 's/local-storage/standard/g' {} \;
      args:
        chdir: install_yamls

    - name: Run gen-crc-pv-kustomize shell script
      shell: |
        make crc_storage
      args:
        chdir: install_yamls

  when: prepare_local_storage
