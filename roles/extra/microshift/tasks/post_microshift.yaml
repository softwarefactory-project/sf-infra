---
- name: Start Microshift now
  become: true
  systemd:
    name: microshift
    state: started
    enabled: true

- name: Wait for kubeconfig file after deploying Microshift
  become: true
  wait_for:
    path: /var/lib/microshift/resources/kubeadmin/kubeconfig
    search_regex: microshift
    delay: 5
    timeout: 300

- name: Create kube config directory
  file:
    path: ~/.kube
    state: directory

- name: Create kube config directory - root
  become: true
  file:
    path: ~/.kube
    state: directory

- name: Copy kubeconfig - user
  become: true
  copy:
    src: /var/lib/microshift/resources/kubeadmin/kubeconfig
    dest: "~{{ ansible_user }}/.kube/config"
    remote_src: true
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Copy kubeconfig - root
  become: true
  copy:
    src: /var/lib/microshift/resources/kubeadmin/kubeconfig
    dest: "~/.kube/config"
    remote_src: true
