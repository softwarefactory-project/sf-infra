---
# NOTE: We install the local-path-provisioner https://github.com/rancher/local-path-provisioner
# mostly to use in CI. Provided by Microshift topolvm requires additional disk,
# create an lvm etc.
# NOTE: Below tasks are similar for those provided in extra/kubernetes role.
- name: Deploy local storage
  become: true
  block:
    - name: Create local storage config dir
      file:
        path: "{{ local_storage_config_dir }}"
        state: directory

    - name: Get local storage manifest
      get_url:
        url: "https://raw.githubusercontent.com/rancher/local-path-provisioner/{{ local_storage_version }}/deploy/local-path-storage.yaml"
        dest: "{{ local_storage_config_dir }}/local-path-storage.yaml"
        mode: "0644"

    - name: Replace docker.io registry to quay.io due rate limit
      shell: |
        sed -i 's#image: rancher/local-path-provisioner:#image: quay.io/software-factory/local-path-provisioner:#g' {{ local_storage_config_dir }}/local-path-storage.yaml
        sed -i 's#image: busybox#image: quay.io/software-factory/busybox#g' {{ local_storage_config_dir }}/local-path-storage.yaml

    - name: Create local path storage - root
      become: true
      shell: |
        /usr/local/bin/oc apply -f {{ local_storage_config_dir }}/local-path-storage.yaml
