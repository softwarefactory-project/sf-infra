---
- name: Install required system packages
  become: true
  yum:
    name:
      - cri-o
      - cri-tools
    state: present
    enablerepo: microshift-deps-rpms
  notify: Restart crio

- name: Get cri-o version
  shell: |
    rpm -qa --qf '%{VERSION}' cri-o
  tags:
    - skip_ansible_lint
  register: _crio_version

- name: Use only ipv4
  become: true
  get_url:
    url: https://raw.githubusercontent.com/cri-o/cri-o/v{{ _crio_version.stdout }}/contrib/cni/11-crio-ipv4-bridge.conf
    dest: /etc/cni/net.d/100-crio-bridge.conf
    mode: "0644"
  notify: Restart crio

- name: Apply container policy from crc
  become: true
  copy:
    src: policy.json
    dest: /etc/containers/policy.json
  notify: Restart crio
  when: overwrite_container_policy

- name: Flush handlers
  meta: flush_handlers
