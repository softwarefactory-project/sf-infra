- name: Set mailname
  become: yes
  copy:
    dest: /etc/mailname
    content: "{{ smtp_host }}"
    owner: root
    group: root
    mode: 0644

- name: Manage main.cf
  become: yes
  copy:
    content: |
      smtpd_banner = $myhostname ESMTP $mail_name
      biff = no
      append_dot_mydomain = no
      inet_interfaces = all
      myhostname = {{ smtp_host }}
      mydomain = {{ smtp_domain }}
      mydestination = $myhostname, localhost
      myorigin = {{ smtp_host }}
      smtpd_relay_restrictions = permit_mynetworks
      smtpd_recipient_restrictions = permit_mynetworks, reject_unauth_destination
      mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128 {{ prometheus_public_ip }}/32
      mailbox_size_limit = 0
      recipient_delimiter = +
    dest: /etc/postfix/main.cf
    owner: root
    group: root
    mode: 0644
  notify:
    - Restart postfix

- name: Start service
  become: yes
  service:
    name: postfix
    enabled: "yes"
    state: started
