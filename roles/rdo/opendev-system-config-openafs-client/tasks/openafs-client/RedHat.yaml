# EPEL is required for dkms to build the openafs kernel modules
# make is required for the %post section of the dkms module installation
- name: Preinstall EPEL and make
  ansible.builtin.package:
    name:
      - make
      - https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm
    state: present
    # apply only for http
    disable_gpg_check: true
  become: yes

- name: Create cache directory
  ansible.builtin.file:
    path: /var/cache/openafs
    state: directory
    owner: root
    group: root
    mode: 0700
    setype: afs_cache_t  # important! hard-to-debug failures without
  become: yes

# Note there is no official AFS builds for CentOS.  This uses a
# repository built by the project-config-build-openafs-centos job, see
#  https://opendev.org/cgit/openstack/openstack-zuul-jobs/tree/zuul.d/jobs.yaml

- name: Add AFS repo
  ansible.builtin.yum_repository:
    name: openafs
    description: OpenStack AFS repo
    baseurl: '{{ openafs_client_yum_repo_url }}'
    gpgcheck: '{{ openafs_client_yum_repo_gpg_check }}'
  become: yes

- name: Install kernel modules
  ansible.builtin.dnf:
    name:
      - kernel-devel
      - kernel-headers
      - dkms
      - gcc
      - dkms-openafs
    enablerepo: epel  # dkms
    state: present
  become: yes

- name: Install client
  ansible.builtin.yum:
    name:
      - openafs-krb5
      - openafs-client
    state: present
  become: yes
