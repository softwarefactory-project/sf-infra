---
- name: Create host directories
  become: yes
  file:
    path: /etc/elasticsearch-exporter
    state: directory
    mode: 0644

- include_role:
    name: service/container
  vars:
    pod_name: elasticsearch-exporter
    pod_param: >
      --net=host
      -v /etc/opensearch/certs/:/etc/opensearch/certs/:z
      {{ container_images['elasticsearch_exporter'] | default('quay.io/prometheuscommunity/elasticsearch-exporter:latest') }}
      --es.uri="https://{{ ansible_fqdn }}:9200"
      --es.client-cert=/etc/opensearch/certs/opensearch/opensearch-admin.crt
      --es.client-private-key=/etc/opensearch/certs/opensearch/opensearch-admin.key
      --es.ca=/etc/opensearch/certs/opensearch/localCA.pem
      {% if es_insecure | default(false) %}--es.ssl-skip-verify=true{% endif %}
  when: _opensearch_crt.stat.exists

# NOTE: Remove below task after upgrade to 3.8
- include_role:
    name: service/container
  vars:
    pod_name: elasticsearch-exporter
    pod_param: >
      --net=host
      -v /etc/opensearch/certs/:/etc/opensearch/certs/:z
      {{ container_images['elasticsearch_exporter'] | default('quay.io/prometheuscommunity/elasticsearch-exporter:latest') }}
      --es.uri="https://{{ ansible_fqdn }}:9200"
      --es.client-cert=/etc/opensearch/certs/elasticsearch-admin.crt
      --es.client-private-key=/etc/opensearch/certs/elasticsearch-admin.key
      --es.ca=/etc/opensearch/certs/localCA.pem
      {% if es_insecure | default(false) %}--es.ssl-skip-verify=true{% endif %}
  when: not _opensearch_crt.stat.exists
