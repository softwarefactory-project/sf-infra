---
#   Copyright Red Hat, Inc. All Rights Reserved.
#
#   Licensed under the Apache License, Version 2.0 (the "License"); you may
#   not use this file except in compliance with the License. You may obtain
#   a copy of the License at
#
#       http://www.apache.org/licenses/LICENSE-2.0
#
#   Unless required by applicable law or agreed to in writing, software
#   distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
#   WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#   License for the specific language governing permissions and limitations
#   under the License.

- name: Setup certbot
  become: true
  when: certbot_install | default(true)
  block:
    - name: Install epel-release
      package:
        name:
          - epel-release
      when: ansible_distribution != "Fedora"

    - name: Enable PowerTools repo in Centos 8 stream
      block:
        - name: Remove Centos 8 PowerTools repo
          file:
            path: /etc/yum.repos.d/CentOS-PowerTools.repo
            state: absent

        - name: Install required packages
          package:
            name: dnf-plugins-core
            state: present

        - name: Enable Centos 8 PowerTools stream repository
          shell: |
            yum config-manager --set-enabled powertools

      when:
        - ansible_distribution != "Fedora"
        - ansible_distribution_major_version == "8"

    - name: Install certbot
      package:
        name:
          - certbot
        state: present
        enablerepo: "{{ (ansible_distribution == 'Centos') | ternary('epel', 'updates,fedora') }}"

    - name: Install python certboot library
      package:
        name: "{{ ( ansible_distribution_major_version == '7') | ternary('python2-certbot-apache', 'python3-certbot-apache' ) }}"
        state: present
        enablerepo: "{{ (ansible_distribution == 'Centos') | ternary('epel', 'updates,fedora') }}"
      when:
        - http_service_name != 'nginx'
        - http_service_name != 'standalone'

    # We can use http_service_name variable, to start the service, because
    # both have same name.
    - name: "Install {{ http_service_name }}"
      package: "{{ http_service_name }}"
      when: http_service_name != 'standalone'

    - name: Start "{{ http_service_name }}"
      systemd:
        name: "{{ http_service_name }}"
        state: started
      when: http_service_name != 'standalone'

    # cronie, which provides crontab, might not be installed by default
    - name: Install cronie
      package:
        name: cronie

- name: Generate lets encrypt SSLs
  include_tasks: ssl_create_cert.yml
  with_dict: "{{ ssl_cert_options }}"
  loop_control:
    loop_var: cert_item
  args:
    apply:
      become: true
