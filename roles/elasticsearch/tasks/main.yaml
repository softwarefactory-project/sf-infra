---
- name: Install RPM key
  become: true
  rpm_key:
    state: present
    key: https://artifacts.elastic.co/GPG-KEY-elasticsearch

- name: Install yum repository file
  become: true
  copy:
    src: elasticsearch.repo
    dest: /etc/yum.repos.d/elasticsearch.repo

- name: Install requirements
  become: true
  package:
    name:
      - chkconfig
      - java-1.8.0-openjdk
      - elasticsearch

- name: Set max_clause_count in settings
  become: true
  lineinfile:
    path: /etc/elasticsearch/elasticsearch.yml
    line: "indices.query.bool.max_clause_count: {{ max_clause_count }}"
  notify: Restart elasticsearch

- name: Set Xmx/Xms in JVM settings
  become: true
  replace:
    path: /etc/elasticsearch/jvm.options
    regexp: "^-Xm.*"
    replace: "-Xms{{ xms }} -Xmx{{ xmx }}"
  notify: Restart elasticsearch

- name: Set always restart in systemd file
  become: true
  blockinfile:
    path: /lib/systemd/system/elasticsearch.service
    insertafter: "StandardError=inherit"
    block: |
      Restart=always
      RestartSec=3
  register: _service
  notify: Restart elasticsearch

- name: Enable the service
  become: true
  systemd:
    name: elasticsearch
    daemon-reload: "{% if _service is changed %}yes{% else %}no{% endif %}"
    state: started
    enabled: true
