- name: Install tools
  package:
    name:
      - podman
      - git
      - libvirt-daemon
      - libguestfs-tools
  become: true

- name: Ensure that storage driver is overlay
  lineinfile:
    path: "/etc/containers/storage.conf"
    regexp: '^driver\ =\ \"\w+\"$'
    line: 'driver = "overlay"'
  become: true

- name: Change mount program to fuse-overlays
  lineinfile:
    path: /etc/containers/storage.conf
    regexp: "^#mount_program"
    line: 'mount_program = "/usr/bin/fuse-overlayfs"'
  become: true

- name: Create account
  user:
    name: "{{ item }}"
    home: "/home/{{ item }}"
    shell: /bin/bash
  become: true
  loop:
    - "{{ zuul_container_user }}"
    - "{{ microzuul_nodepool_user }}"

- name: Create home dir
  file:
    path: "/home/{{ item }}"
    state: directory
    owner: "{{ item }}"
  become: true
  loop:
    - "{{ zuul_container_user }}"
    - "{{ microzuul_nodepool_user }}"

- name: Download container-update project key
  get_url:
    url: "{{ zuul_container_update_key }}"
    dest: "/home/{{ zuul_container_user }}/container_update_key.pub"
    force: true
    timeout: 60
  register: dl_result
  until: dl_result is succeeded
  retries: 20
  delay: 1
  become: true

- name: get key contents
  command: "cat /home/{{ zuul_container_user }}/container_update_key.pub"
  register: cu_pubkey
  become: true

- name: debug key
  debug:
    msg: "{{ cu_pubkey }}"

- name: "Authorized {{ zuul_container_user }} executor"
  become: true
  authorized_key:
    user: "{{ zuul_container_user }}"
    state: present
    key: "{{ cu_pubkey.stdout }}"

- name: "Authorized {{ microzuul_nodepool_user }} executor"
  become: true
  authorized_key:
    user: "{{ microzuul_nodepool_user }}"
    state: present
    key: "{{ microzuul_nodepool_key }}"
