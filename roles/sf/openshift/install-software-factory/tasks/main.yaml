---
- name: Create Namespace {{ sf_namespace }}
  kubernetes.core.k8s:
    state: present
    kind: Namespace
    name: "{{ sf_namespace }}"

- name: Add Security Context Constraints to User
  ansible.builtin.command: >
    oc adm policy
    add-scc-to-user
    privileged system:serviceaccount:{{ sf_namespace }}:default

# When this Secret 'sf-ssl-cert' is set then sf-operator uses its content to setup Routes' TLS.
- name: Install TLS Secret for the Route
  kubernetes.core.k8s:
    state: present
    name: sf-ssl-cert
    definition: "{{ sf_ssl_cert_secret }}"
  no_log: true
  when: sf_ssl_cert_secret is defined

# When this ConfigMap 'corporate-ca-certs' is set then sf-operator adds the CA Cert(s) to the
# containers CA Trust chains
- name: Install corporate-ca-certs for CA Trust Chains
  kubernetes.core.k8s:
    state: present
    name: corporate-ca-certs
    definition: "{{ corporate_ca_certs }}"
  when: corporate_ca_certs is defined

- name: Install Nodepool providers secrets
  kubernetes.core.k8s:
    state: present
    definition: "{{ nodepool_providers_secrets }}"
  no_log: true
  when: nodepool_providers_secrets is defined

- name: Install Zuul connections secrets
  kubernetes.core.k8s:
    state: present
    definition: "{{ item }}"
  no_log: true
  loop: "{{ zuul_connections_secrets }}"

- name: Install Software Factory
  kubernetes.core.k8s:
    state: present
    definition: "{{ software_factory }}"
