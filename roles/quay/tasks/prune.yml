- name: Install required packages
  become: true
  package:
    name:
      - jq
      - python3-virtualenv
      - python3-requests
    state: present

- name: Install image tag pruner
  become: true
  copy:
    src: quay_tag_pruner.py
    dest: /usr/local/bin/quay_tag_pruner
    mode: '0755'

- name: Install tag keeplist generator
  become: true
  template:
    src: quay_tag_keeplist.sh.j2
    dest: /usr/local/bin/quay_tag_keeplist
    mode: '0755'

- name: Install wrapper script
  become: true
  template:
    src: quay_registry_pruner.sh.j2
    dest: /usr/local/bin/quay_registry_pruner
    mode: '0755'

- name: Set up prune log directory
  become: true
  file:
    path: "{{ quay_pruner_log_directory }}"
    state: directory

- name: Set logrorate config file
  become: true
  copy:
    src: quay_pruner.logrotate
    dest: /etc/logrotate.d/quay_pruner
    mode: "0644"

- name: Set up cron to prune tags and images
  become: true
  cron:
    name: quay_image_pruning
    minute: 0
    hour: 1
    user: root
    job: '/usr/local/bin/quay_registry_pruner > {{ quay_pruner_log_directory }}/pruner.$(/usr/bin/date +\%s).log 2>&1'
