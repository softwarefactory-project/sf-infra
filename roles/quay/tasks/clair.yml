---
- name: Create Clair DB
  postgresql_db:
    login_host: "{{ postgresql_host | default('localhost') }}"
    login_user: "{{ postgresql_user }}"
    login_password: "{{ postgresql_password }}"
    name: clair
    state: present
  no_log: true

- name: Set Clair service config
  template:
    src: clair_config.yml.j2
    dest: /var/data/clair/config/config.yml
    mode: '0777'

# NOTE: with host network, -p 6060:6060 is not needed.
- name: Create Clair container
  include_role:
    name: container-service
  vars:
    pod_name: clair
    pod_param: >
      --network host
      --restart=always
      -v /var/data/clair/config:/clair/config:Z
      {{ container_images['clair'] | default('quay.io/projectquay/clair:4.3.5') }}
      -conf /clair/config/config.yml -mode combo
