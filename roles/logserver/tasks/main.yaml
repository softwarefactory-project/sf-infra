---
- name: check for tls cert
  become: yes
  stat:
    path: "{{ le_base_path }}/{{ fqdn }}/cert.pem"
  register: _tls_cert

- name: setup vhost
  template:
    src: vhost.j2
    dest: /etc/httpd/conf.d/logserver.vhost.conf
  become: yes

- name: Create logs directory
  file:
    path: /var/www/logs
    state: directory
    owner: loguser
    group: apache
    mode: 0755

- name: Remove old purge-logs script
  become: yes
  file:
    path: /usr/local/bin/purge-logs.sh
    state: absent

- name: Install purge-logs script
  become: yes
  copy:
    src: purge-logs.py
    dest: /usr/local/bin/purge-logs.py
    mode: 0755

- name: Install crontab for purge-logs
  become: yes
  cron:
    name: purge-logs
    user: loguser
    job: "/usr/local/bin/purge-logs.py --retention-days {{ logs_expiry }}"
    hour: 5
    minute: 0
