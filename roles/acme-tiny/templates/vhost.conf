<VirtualHost *:80>
    ServerName {{ item.domain }}
    Alias /.well-known/acme-challenge {{ acme_challenges_dir }}/{{ item.domain }}
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteCond %{REMOTE_HOST} !{{ item.domain }}$
    RewriteCond %{REQUEST_URI} !\.well-known/acme-challenge
    RewriteRule (.*) https://{{ item.domain }}%{REQUEST_URI} [R=301,L]

    CustomLog "logs/{{ item.domain }}_access_log" combined
    ErrorLog "logs/{{ item.domain }}_error_log"
</VirtualHost>

{% for cert_files_result in _cert_files["results"] %}
{% if cert_files_result.stat.exists and cert_files_result["item"]["domain"] == item.domain %}
<VirtualHost *:443>
    ServerName {{ item.domain }}
    Alias / {{ item.vhost_root }}

    SSLEngine on
    SSLCertificateFile      {{ acme_certs_dir }}/{{ item.domain }}.pem
                            # TODO: check where this come from and install it
    SSLCertificateChainFile /etc/letsencrypt/pem/lets-encrypt-x3-cross-signed.pem
    SSLCertificateKeyFile   {{ acme_keys_dir }}/{{ item.domain }}.key

    CustomLog "logs/{{ item.domain }}_access_log" combined
    ErrorLog "logs/{{ item.domain }}_error_log"
</VirtualHost>
{% endif %}{% endfor %}
