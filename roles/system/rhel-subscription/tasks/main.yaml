---
- name: Check rhel version
  become: true
  ansible.builtin.command: subscription-manager release
  register: _rhel_version
  ignore_errors: yes

- name: Register, update  and reboot system
  become: true
  when: "'This system is not yet registered' in _rhel_version.stderr"
  block:
    - name: Register system
      community.general.redhat_subscription:
        state: present
        activationkey: "{{ rhel_activationkey }}"
        org_id: "{{ rhel_org_id }}"
        release: "{{ ansible_distribution_version }}"
      no_log: yes

    - name: Ensure Extended Update Support repos are disabled
      community.general.rhsm_repository:
        name: "{{ item }}"
        state: disabled
      loop:
        - rhel-9-for-x86_64-baseos-eus-rpms
        - rhel-9-for-x86_64-appstream-eus-rpms

    - name: Upgrade all packages
      ansible.builtin.dnf:
        name: "*"
        state: latest

    - name: Reboot after initial upgrade
      ansible.builtin.reboot:

- name: Install dnf-automatic
  ansible.builtin.dnf:
    name: "dnf-automatic"
  become: true

- name: Disable a timer unit for dnf-automatic
  ansible.builtin.systemd_service:
    name: dnf-automatic.timer
    state: stopped
    enabled: false
  become: true

- name: Enable a timer unit for dnf-automatic-install
  ansible.builtin.systemd_service:
    name: dnf-automatic-install.timer
    state: started
    enabled: true
  become: true
