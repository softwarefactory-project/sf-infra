---
- name: Setup crontab for reboot alerts
  become: yes
  block:
    - name: Ensure dnf-utils package
      # contains needs-restarting
      ansible.builtin.dnf:
        name: dnf-utils

    # TODO can be removed after merge
    - name: Disable crontab for periodical dnf check-update
      ansible.builtin.cron:
        name: Check if package need update
        minute: "{{ 59 | random }}"
        hour: "{{ 3 | random }}"
        job: echo "system_package_update $(/usr/bin/dnf check-update > /dev/null && echo 0 || echo 1)" > /var/lib/node_exporter/textfile_collector/system_package_update.prom
        state: absent

    # TODO can be removed after merge
    - name: Remove unused files
      ansible.builtin.file:
        path: /var/lib/node_exporter/textfile_collector/system_package_update.prom
        state: absent

    # needs-restarting return 0 if reboot is not needed
    - name: Create crontab for periodical check if reboot is needed
      ansible.builtin.cron:
        name: Check if reboot is needed
        minute: "{{ 59 | random }}"
        hour: "{{ 3 | random }}"
        job: echo "system_reboot $(/bin/needs-restarting --reboothint > /dev/null && echo 0 || echo 1)" > /var/lib/node_exporter/textfile_collector/system_reboot.prom
