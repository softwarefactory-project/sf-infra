---
- name: check for tls cert
  become: yes
  stat:
    path: "/etc/letsencrypt/live/{{ fqdn }}/cert.pem"
  register: _tls_cert

- name: enable httpd proxy
  become: yes
  seboolean:
    name: httpd_can_network_connect
    state: yes
    persistent: yes

- name: setup vhost
  template:
    src: vhost.j2
    dest: /etc/httpd/conf.d/monitoring.vhost.conf
  become: yes

- name: setup proxypass
  become: yes
  copy:
    content: |
      ProxyPreserveHost On
      ProxyRequests Off

      ProxyPass        /prometheus http://localhost:9090/prometheus
      ProxyPassReverse /prometheus http://localhost:9090/prometheus

      ProxyPass /grafana http://localhost:3000/
      ProxyPassReverse /grafana http://localhost:3000/

      ProxyPass        /alertmanager http://localhost:9093/alertmanager
      ProxyPassReverse /alertmanager http://localhost:9093/alertmanager

    dest: /etc/httpd/conf.d/proxypass.conf

- name: setup index
  become: yes
  copy:
    content: |
      <html>
      <body>
      Welcome
      <ul>
      <li><a href="/grafana">grafana</a></li>
      <li><a href="/prometheus">prometheus</a></li>
      <li><a href="/alertmanager">alerts</a></li>
      </ul>
      </body>
      </html>
    dest: /var/www/html/index.html
