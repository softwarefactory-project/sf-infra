---
- block:
    - name: Gather package facts
      package_facts:
        manager: auto

    - name: Install package from copr
      yum:
        name: https://copr-be.cloud.fedoraproject.org/results/ibotty/prometheus-exporters/epel-7-x86_64/00935314-golang-github-prometheus-node_exporter/golang-github-prometheus-node_exporter-0.18.1-6.el7.x86_64.rpm
      when:
        - "('golang-github-prometheus-node_exporter' not in ansible_facts.packages) or ('golang-github-prometheus-node_exporter' in ansible_facts.packages and ansible_facts.packages['golang-github-prometheus-node_exporter'][0]['version'] != '0.18.1')"

    - name: Adding service suffix for prometheus_monitored_services
      set_fact:
        prometheus_monitored_services: "{{ prometheus_monitored_services | product(['.service']) | map('join') | list }}"
      when: prometheus_monitored_services is defined

    - name: Add systemd monitoring if required
      lineinfile:
        path: /etc/sysconfig/node_exporter
        regexp: '^OPTIONS='
        line: "OPTIONS=\"--collector.textfile.directory /var/lib/node_exporter/textfile_collector --collector.systemd --collector.systemd.unit-whitelist='{{ prometheus_monitored_services | join('|') }}' --collector.netstat.fields=(.*) --collector.vmstat.fields=(.*)  --collector.interrupts\""
      when: prometheus_monitored_services is defined
      notify:
        - Restart node-exporter

    - name: Start the service
      service:
        name: node_exporter
        state: started
        enabled: true
  become: yes
