---
- name: Configure service
  become: yes
  block:
    - name: Install epel-release
      yum:
        name: epel-release

    - name: Install packages
      yum:
        name: "{{ afs_mirror_packages }}"

    - name: Clone puppet-openstackci
      git:
        repo: https://opendev.org/opendev/puppet-openstackci
        dest: /etc/puppet/modules/openstackci
        force: yes

    - name: Get CentOS patches for puppet-openstackci
      command: "{{ item }}"
      loop:
        - git config user.name "sf-infra"
        - git config user.email softwarefactory-operations-team@redhat.com
        - git fetch https://review.opendev.org/opendev/puppet-openstackci refs/changes/76/529376/24
        - git cherry-pick FETCH_HEAD
        - git fetch https://review.opendev.org/opendev/puppet-openstackci refs/changes/39/528739/33
        - git cherry-pick FETCH_HEAD
      args:
        chdir: /etc/puppet/modules/openstackci
      # TODO: fix cherry pick issue for spec/acceptance/basic_spec.rb, then
      # remove ignore_errors
      ignore_errors: yes

    - name: Clone required puppet modules
      git:
        repo: "https://opendev.org/opendev/{{ item }}"
        dest: "/tmp/{{ item }}"
        force: yes
      loop: "{{ afs_puppet_modules }}"

    - name: Build and install puppet modules
      shell: "puppet module build && puppet module install /tmp/{{ item }}/pkg/*.tar.gz"
      args:
        chdir: "/tmp/{{ item }}"
      loop: "{{ afs_puppet_modules }}"

    - name: Install other dependencies
      command: puppet module install puppetlabs-ntp --version 3.2.1

    - name: Install puppet manifest
      template:
        src: site.pp.j2
        dest: /root/site.pp

    - name: Apply puppet manifest
      command: puppet apply /root/site.pp
