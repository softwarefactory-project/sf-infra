---
- name: Create host directories
  become: yes
  file:
    path: /etc/prometheus
    state: directory

- name: Create configuration file
  become: yes
  copy:
    content: "{{ item.content }}"
    dest: "/etc/prometheus/{{ item.dest }}.yml"
  loop:
    - dest: prometheus
      content: |
        ---
        global:
          scrape_interval: 1m
          scrape_timeout: 10s
          evaluation_interval: 1m
        alerting:
          alertmanagers:
            - static_configs:
                - targets:
                    - localhost:9093
        rule_files:
          - rules.yml
        scrape_configs:
          - job_name: node
            static_configs:
              - targets:
                  - bridge.softwarefactory-project.io:9100
    - dest: rules
      content: |
        groups:
          - name: node.rules
            rules:
              - alert: InstanceDown
                expr: up{job="node"} == 0
                for: 10m
  register: _prom_config

- include_role:
    name: container-service
  vars:
    pod_name: prometheus
    pod_param: -p 9090:9090 -v /etc/prometheus/:/etc/prometheus/ quay.io/prometheus/prometheus
    pod_config: "{{ _prom_config }}"
