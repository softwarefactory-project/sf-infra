---
- name: Create host directories
  become: yes
  file:
    path: "{{ item.path }}"
    state: directory
    mode: "{{ item.mode|default(omit) }}"
  loop:
    - path: /etc/prometheus
    - path: /var/lib/prometheus
      mode: "0777"

- name: Create configuration file
  become: yes
  copy:
    content: "{{ item.content }}"
    dest: "/etc/prometheus/{{ item.dest }}.yml"
  loop:
    - dest: prometheus
      content: |
        ---
        global:
          scrape_interval: 1m
          scrape_timeout: 10s
          evaluation_interval: 1m
        alerting:
          alertmanagers:
            - path_prefix: /alertmanager
              static_configs:
                - targets:
                    - localhost:9093
        rule_files:
          - rules.yml
          - rules-http.yml
          - rules-backup.yml
          - rules-dlrn.yml
          - rules-afs.yml
        scrape_configs:
          - job_name: node
            static_configs:
              - targets:
                  - bridge.softwarefactory-project.io:9100
                  - mirror.regionone.vexxhost.rdoproject.org:9100
                  - logreduce-mqtt01.softwarefactory-project.io:9100
                  - backup.rdoproject.org:9100
                  - prometheus.monitoring.softwarefactory-project.io:9100
                  - rpm-packaging-ci.rdoproject.org:9100
                  - fedora-rpm-packaging-ci.rdoproject.org:9100
                  - centos8-rpm-packaging-ci.rdoproject.org:9100
                  - trunk-centos8.rdoproject.org:9100
                  - trunk-centos7.rdoproject.org:9100
                  - trunk.rdoproject.org:9100
                  - images-vexxhost.rdoproject.org:9100
                  - logserver.rdoproject.org:9100
          - job_name: journal
            static_configs:
              - targets:
                  - logreduce-mqtt01.softwarefactory-project.io:9101
          - job_name: 'blackbox'
            scrape_interval: 5m
            metrics_path: /probe
            params:
              module: [http_2xx]
            static_configs:
              - targets: {{ web_monitor_list }}
            relabel_configs:
              - source_labels: [__address__]
                target_label: __param_target
              - source_labels: [__param_target]
                target_label: instance
              - target_label: __address__
                replacement: 127.0.0.1:9115  # Blackbox exporter

    # Some doc:
    #   Check alert status: curl -g 'http://localhost:9090/api/v1/alerts' | python -mjson.tool
    #   Get metrics names: curl -g 'http://localhost:9090/api/v1/label/__name__/values' | tr ',' '\n'
    #   Test expr: curl -g 'http://localhost:9090/api/v1/query' --data-urlencode 'query=predict_linear(node_filesystem_avail_bytes{job="node",mountpoint="/",instance="logreduce-mqtt01.softwarefactory-project.io:9100"}[1d], 365 * 24 * 3600)'
    - dest: rules
      content: |
        groups:
          - name: node.rules
            rules:
              - alert: InstanceDown
                expr: up{job="node"} == 0
                for: 10m
              - alert: WillRunOutOfDiskInThreeDays
                # Over 1 day, if the slope becomes negative in 3 days, then emit an alarm
                expr: predict_linear(node_filesystem_avail_bytes{job="node"}[1d], 3 * 24 * 3600) < 0
                for: 1h
              - alert: WillRunOutOfMemoryInThreeDays
                expr: predict_linear(node_memory_MemAvailable_bytes{job="node"}[1d], 3 * 24 * 3600) < 0
                for: 1h

    - dest: rules-http
      content: |
        groups:
          - name: blackbox.rules
            rules:
              - alert: WebDown
                expr: probe_success{job="blackbox"} == 0
                for: 10m
              - alert: SSLCertExpiringSoon
                expr: probe_ssl_earliest_cert_expiry{job="blackbox"} - time() < 86400 * 7
                for: 10m

    - dest: rules-backup
      content: !unsafe |
        groups:
          - name: backup.rules
            rules:
              - alert: BackupTooOld
                # Time since last backup is more than three days
                expr: bup_last_backup{job="node"} < (time() - 259200)
                labels:
                  severity: warning
                  lasttime: '{{ $value | humanizeTimestamp }}'
                annotations:
                  summary: 'Backup for {{ $labels.dir }} has not been updated since {{ $value | humanizeTimestamp }}'

    - dest: rules-afs
      content: !unsafe |
        groups:
          - name: afs.rules
            rules:
              - alert: AFSTooOld
                # Time since last mirror is more than one day
                expr: afs_mirror_sync_time{job="node"} < (time() - 86400)
                labels:
                  severity: warning
                  lasttime: '{{ $value | humanizeTimestamp }}'
                annotations:
                  summary: 'Last AFS mirror sync for {{ $labels.target }} dates back to {{ $value | humanizeTimestamp }}'

    - dest: rules-dlrn
      content: !unsafe |
        groups:
          - name: dlrn.rules
            rules:
              - alert: RDOTrunkRepoTooOld
                # Time since last build is more than one day
                expr: dlrn_last_build{job="node"} < (time() - 86400)
                labels:
                  severity: warning
                  lasttime: '{{ $value | humanizeTimestamp }}'
                annotations:
                  summary: 'Last build for {{ $labels.worker }}/{{ $labels.symlink }} dates back to {{ $value | humanizeTimestamp }}'
  register: _prom_config

- include_role:
    name: container-service
  vars:
    pod_name: prometheus
    pod_param: >
      --network host
      -v /etc/prometheus/:/etc/prometheus/:Z
      -v /var/lib/prometheus:/prometheus:Z
      quay.io/prometheus/prometheus
      --web.external-url=https://prometheus.monitoring.softwarefactory-project.io/prometheus/
      --web.route-prefix="prometheus"
      --config.file=/etc/prometheus/prometheus.yml
    pod_config: "{{ _prom_config }}"
