---
- name: Create host directories
  become: yes
  file:
    path: "{{ item.path }}"
    state: directory
    mode: "{{ item.mode|default(omit) }}"
  loop:
    - path: /etc/prometheus
    - path: /var/lib/prometheus
      mode: "0777"

- name: Create configuration file
  become: yes
  copy:
    src: "{{ item }}.yaml"
    dest: "/etc/prometheus/{{ item }}.yaml"
  loop:
    - "prometheus"
    - "rules-node"
    - "rules-node_proxy"
    - "rules-http"
    - "rules-backup"
    - "rules-afs"
    - "rules-dlrn"
    - "rules-systemd"
    - "rules-nodepool"
  register: _prom_config

- include_role:
    name: container-service
  vars:
    pod_name: prometheus
    pod_param: >
      --network host
      -v /etc/prometheus/:/etc/prometheus/:Z
      -v /var/lib/prometheus:/prometheus:Z
      quay.io/prometheus/prometheus
      --web.external-url=https://prometheus.monitoring.softwarefactory-project.io/prometheus/
      --web.route-prefix="prometheus"
      --config.file=/etc/prometheus/prometheus.yaml
    pod_config: "{{ _prom_config }}"
