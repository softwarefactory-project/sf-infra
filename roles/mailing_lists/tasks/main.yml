---

- name: "Check ml_type is defined"
  fail:
    msg: "Please define the Mailman version (ml_type) to either 'mm2' or 'mm3'"
  when: ml_type is not defined

- name: "Create Space for Mailing-Lists data"
  vars:
    fs_type: xfs
  block:
    - name: "Create filesystem for Mailing-Lists data"
      filesystem:
        fstype: "{{ fs_type }}"
        dev: "{{ data_dev }}"

    - name: "Mount filesystem for Mailing-Lists data"
      mount:
        src: "{{ data_dev }}"
        path: "{{ data_path }}"
        fstype: "{{ fs_type }}"
        state: mounted

    - name: Add swap file
      include_role:
        name: swap_file
      vars:
        size: 1G
        path: /var/swap
      when: ml_type == "mm3"

  tags: partitioning


- name: "Deploy Mailman 2"
  block:
    - name: "Install SpamAssassin"
      include_role:
        name: spamassassin
      vars:
        service_profile: medium

    - name: "Install web vhost '{{ website_domain }}'"
      include_role:
        name: httpd
        tasks_from: vhost

    - name: "Install Mailman 2"
      include_role:
        name: mailman2

    - name: "Install Postgrey"
      include_role:
        name: postgrey
      vars:
        whitelist_clients:
          - redhat.com

    - name: "Install Postfix"
      include_role:
        name: postfix
      vars:
        myhostname: "{{ inventory_hostname }}"
        relay_domains:
          - lists.rdoproject.org
        with_mailman2: true
        with_postgrey: true
        with_spamassassin: true
        # used for selective antispam
        smtpd_recipient_restrictions_custom:
          - "check_recipient_access pcre:$config_directory/recipients_access"
        aliases:
          root: "{{ ['root'] + ml_error_emails }}"
          listmaster: root
        local_accounts:
          - privacy

    - name: "Use the second disk for all Mailman2 data"
      include_role:
        name: data_movebind
      vars:
        src: /var/lib/mailman
        dest: "{{ data_path }}/mailman2-lib"
        services:
          - crond
          - mailman
          - httpd

  when: ml_type == "mm2"
  tags: mailinglists


- name: "Deploy Mailman 3"
  block:
    - name: "Install Mailing-Lists Server"
      include_role:
        name: mailing_lists_server
        public: yes
      vars:
        display_name: "RDO List Archives"
        domain: rdoproject.org
        webui_vhost: lists.rdoproject.org
        admin_users:
          - duck
          - misc
          # TODO: add RDO folks
        mail_aliases:
          root: "{{ ['root'] + ml_error_emails }}"
          listmaster: root
        local_accounts:
          - privacy
        # used for selective antispam
        smtpd_recipient_restrictions_custom:
          - "check_recipient_access pcre:$config_directory/recipients_access"
        # TODO: enable after migration
        #use_simple_tls: True
        with_dovecot: True
        whitelist_clients:
          - redhat.com
        service_profile: medium

    - name: "Use the second disk for all Mailman3 database"
      include_role:
        name: data_movebind
      vars:
        src: /var/lib/pgsql
        dest: "{{ data_path }}/mailman3-database"
        services:
          - crond
          - mailman3
          - httpd
          - postgresql

    - name: "Use the second disk for all Mailman3 data"
      include_role:
        name: data_movebind
      vars:
        src: /var/lib/mailman3
        dest: "{{ data_path }}/mailman3-lib"
        services:
          - crond
          - mailman3
          - httpd

    - name: "Use the second disk for all Hyperkitty+Postorius data"
      include_role:
        name: data_movebind
      vars:
        src: /var/www/mailman
        dest: "{{ data_path }}/mailman3-www"
        services:
          - crond
          - mailman3
          - httpd

    - name: Configure web access to old ML archives
      copy:
        src: "old_ml_archives.conf"
        dest: "{{ _vhost_confdir }}/"
        owner: root
        group: root
        mode: 0644
      notify: reload httpd

    - name: Install custom favicon
      copy:
        src: "{{ item }}"
        dest: "{{ webapp_path }}/static-extra/"
        owner: root
        group: root
        mode: 0644
      loop:
        - favicon.ico
        - rdo_logo.png
      notify: Update static files

    - name: Install custom branded navbar template
      copy:
        src: "navbar-brand.html"
        dest: "{{ webapp_path }}/templates/hyperkitty/"
        owner: root
        group: root
        mode: 0644
      notify: reload apache

  when: ml_type == "mm3"
  tags: mailinglists

- name: "Deploy Extra Mail Settings"
  block:
    - name: "Install extra maps"
      copy:
        src: "{{ item }}"
        dest: "/etc/postfix/{{ item }}"
      with_items:
        - recipients_access
      notify: regenerate mail maps

    # quick fix for SPAM generating a low Spamassassin score
    - name: "SPAM filtering"
      copy:
        src: "sa_rdo_mls.cf"
        dest: "{{ sa_config_bits }}/10_rdo_mls.cf"
      notify: regenerate spamassassin configuration

    - name: "Discard very-likely SPAM"
      blockinfile:
        path: /etc/postfix/header_checks
        block: |
          /^X-Spam-Level: \*{8,}/ DISCARD
        marker: "# {mark} ANSIBLE MANAGED BLOCK ML-SPAM"
      notify: reload mail system

    - name: "Install Dovecot users"
      copy:
        src: "users/"
        dest: /etc/dovecot/users/

  tags: mailinglists

