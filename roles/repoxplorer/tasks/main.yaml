---
- name: Install SF master repository
  become: true
  yum_repository:
    name: sf-master
    description: SF master repository
    baseurl: https://softwarefactory-project.io/kojifiles/repos/sf-master-el7/
    gpgcheck: false

- name: Install requirements
  become: true
  package:
    name:
      - python3-pytz
      - repoxplorer
    state: present
  register: _packages

- name: Create some runtime directories
  become: true
  file:
    path: "/var/lib/repoxplorer/{{ item }}"
    owner: repoxplorer
    group: repoxplorer
    state: directory
  loop:
    - db
    - cache
    - git_store

- name: Install application config
  become: true
  template:
    src: config.py.j2
    dest: /etc/repoxplorer/config.py
    owner: repoxplorer
    group: repoxplorer
  register: _config
  notify: Restart repoxplorer

- name: Install web assets
  become: true
  command: |
    /usr/bin/repoxplorer-fetch-web-assets
    --config /etc/repoxplorer/config.py
  when: _config is changed
  notify: Restart repoxplorer

- name: Enable the service
  become: true
  systemd:
    name: "{{ item }}"
    daemon-reload: "{% if _packages is changed %}true{% else %}no{% endif %}"
    state: started
    enabled: true
  loop:
    - repoxplorer
    - repoxplorer-webui
